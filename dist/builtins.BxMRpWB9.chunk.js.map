{"version":3,"file":"builtins.BxMRpWB9.chunk.js","sources":["../src/functions/builtins.ts"],"sourcesContent":["/**\r\n * 内置函数库 - 提供与 MVU/SAM 兼容的基础函数\r\n *\r\n * MVU (MagVarUpdate) - 使用最广泛\r\n * SAM (Situational Awareness Manager) - FSM 状态管理\r\n */\r\n\r\n/**\r\n * 生成内置函数列表\r\n * @returns {Array<import('./registry.js').FunctionDefinition>}\r\n */\r\nexport function getBuiltinFunctions() {\r\n  return [\r\n    // ==================== SET (MVU/SAM 通用) ====================\r\n    {\r\n      id: \"builtin-set\",\r\n      name: \"SET\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 10,\r\n      builtin: true,\r\n      description: '设置变量的值。语法: @.SET(\"path\", value);',\r\n      executor: `\r\n// SET(path, value) - 设置变量值\r\nconst [path, valueStr] = args;\r\n\r\n// 解析值（JSON 格式）\r\nlet value;\r\ntry {\r\n  value = JSON.parse(valueStr);\r\n} catch (e) {\r\n  // 解析失败，作为字符串处理（去掉引号）\r\n  value = valueStr.replace(/^[\"']|[\"']$/g, '');\r\n}\r\n\r\n// 使用 lodash 的 set 方法\r\n_.set(snapshot, path, value);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== ADD (MVU/SAM 通用) ====================\r\n    {\r\n      id: \"builtin-add\",\r\n      name: \"ADD\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 20,\r\n      builtin: true,\r\n      description:\r\n        '数值加法或数组追加。如果目标是数组则追加，否则作数值加法。语法: @.ADD(\"path\", value);',\r\n      executor: `\r\n// ADD(path, value) - 数值加法或数组追加（兼容 MVU/SAM）\r\nconst [path, valueStr] = args;\r\n\r\n// 获取当前值\r\nconst currentValue = _.get(snapshot, path);\r\n\r\n// 如果是数组，追加元素（SAM 行为）\r\nif (Array.isArray(currentValue)) {\r\n  let value;\r\n  try {\r\n    value = JSON.parse(valueStr);\r\n  } catch (e) {\r\n    value = valueStr.replace(/^[\"']|[\"']$/g, '');\r\n  }\r\n  currentValue.push(value);\r\n  _.set(snapshot, path, currentValue);\r\n  return snapshot;\r\n}\r\n\r\n// 否则作为数值加法（MVU 行为）\r\nconst num = parseFloat(valueStr);\r\nif (isNaN(num)) {\r\n  console.warn('[ST-VarSystem] ADD: 无效的数值参数:', valueStr);\r\n  return snapshot;\r\n}\r\n\r\nconst newValue = (parseFloat(currentValue) || 0) + num;\r\n_.set(snapshot, path, newValue);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== SUB (MVU 特有) ====================\r\n    {\r\n      id: \"builtin-sub\",\r\n      name: \"SUB\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 30,\r\n      builtin: true,\r\n      description: '数值减法。语法: @.SUB(\"path\", number);',\r\n      executor: `\r\n// SUB(path, number) - 数值减法\r\nconst [path, numStr] = args;\r\nconst num = parseFloat(numStr);\r\n\r\nif (isNaN(num)) {\r\n  console.warn('[ST-VarSystem] SUB: 无效的数值参数:', numStr);\r\n  return snapshot;\r\n}\r\n\r\nconst currentValue = _.get(snapshot, path, 0);\r\nconst newValue = (parseFloat(currentValue) || 0) - num;\r\n_.set(snapshot, path, newValue);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== DEL (SAM 特有) ====================\r\n    {\r\n      id: \"builtin-del\",\r\n      name: \"DEL\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 35,\r\n      builtin: true,\r\n      description: '删除数组中指定索引的元素。语法: @.DEL(\"path\", index);',\r\n      executor: `\r\n// DEL(path, index) - 删除数组元素（SAM）\r\nconst [path, indexStr] = args;\r\nconst index = parseInt(indexStr);\r\n\r\nif (isNaN(index) || index < 0) {\r\n  console.warn('[ST-VarSystem] DEL: 无效的索引:', indexStr);\r\n  return snapshot;\r\n}\r\n\r\nconst arr = _.get(snapshot, path);\r\nif (!Array.isArray(arr)) {\r\n  console.warn('[ST-VarSystem] DEL: 目标不是数组:', path);\r\n  return snapshot;\r\n}\r\n\r\nif (index >= arr.length) {\r\n  console.warn('[ST-VarSystem] DEL: 索引超出范围:', index);\r\n  return snapshot;\r\n}\r\n\r\narr.splice(index, 1);\r\n_.set(snapshot, path, arr);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== APPEND (MVU 特有) ====================\r\n    {\r\n      id: \"builtin-append\",\r\n      name: \"APPEND\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 40,\r\n      builtin: true,\r\n      description: '向数组末尾追加元素。语法: @.APPEND(\"path\", value);',\r\n      executor: `\r\n// APPEND(path, value) - 数组追加（MVU）\r\nconst [path, valueStr] = args;\r\n\r\n// 解析值\r\nlet value;\r\ntry {\r\n  value = JSON.parse(valueStr);\r\n} catch (e) {\r\n  value = valueStr.replace(/^[\"']|[\"']$/g, '');\r\n}\r\n\r\n// 获取当前数组\r\nlet arr = _.get(snapshot, path);\r\n\r\n// 如果不存在或不是数组，创建新数组\r\nif (!Array.isArray(arr)) {\r\n  arr = [];\r\n}\r\n\r\narr.push(value);\r\n_.set(snapshot, path, arr);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== REMOVE (MVU 特有) ====================\r\n    {\r\n      id: \"builtin-remove\",\r\n      name: \"REMOVE\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 50,\r\n      builtin: true,\r\n      description:\r\n        '从数组中移除元素（按索引或值）。语法: @.REMOVE(\"path\", indexOrValue);',\r\n      executor: `\r\n// REMOVE(path, indexOrValue) - 数组删除（MVU）\r\nconst [path, targetStr] = args;\r\n\r\n// 获取当前数组\r\nlet arr = _.get(snapshot, path);\r\n\r\nif (!Array.isArray(arr)) {\r\n  console.warn('[ST-VarSystem] REMOVE: 目标不是数组:', path);\r\n  return snapshot;\r\n}\r\n\r\n// 尝试解析为索引（数字）\r\nconst index = parseInt(targetStr);\r\nif (!isNaN(index) && index >= 0 && index < arr.length) {\r\n  // 按索引删除\r\n  arr.splice(index, 1);\r\n} else {\r\n  // 按值删除\r\n  let value;\r\n  try {\r\n    value = JSON.parse(targetStr);\r\n  } catch (e) {\r\n    value = targetStr.replace(/^[\"']|[\"']$/g, '');\r\n  }\r\n  \r\n  const idx = arr.indexOf(value);\r\n  if (idx !== -1) {\r\n    arr.splice(idx, 1);\r\n  }\r\n}\r\n\r\n_.set(snapshot, path, arr);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== SELECT_SET (SAM 特有) ====================\r\n    {\r\n      id: \"builtin-select-set\",\r\n      name: \"SELECT_SET\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 60,\r\n      builtin: true,\r\n      description:\r\n        '在数组中查找对象并设置其属性。语法: @.SELECT_SET(\"path\", \"selectorKey\", \"selectorValue\", \"receiverKey\", newValue);',\r\n      executor: `\r\n// SELECT_SET(path, selectorKey, selectorValue, receiverKey, newValue) - SAM\r\nconst [path, selectorKey, selectorValue, receiverKey, newValueStr] = args;\r\n\r\nconst arr = _.get(snapshot, path);\r\nif (!Array.isArray(arr)) {\r\n  console.warn('[ST-VarSystem] SELECT_SET: 目标不是数组:', path);\r\n  return snapshot;\r\n}\r\n\r\n// 解析新值\r\nlet newValue;\r\ntry {\r\n  newValue = JSON.parse(newValueStr);\r\n} catch (e) {\r\n  newValue = newValueStr.replace(/^[\"']|[\"']$/g, '');\r\n}\r\n\r\n// 查找匹配的对象\r\nconst targetObj = arr.find(item => \r\n  item && typeof item === 'object' && item[selectorKey] === selectorValue\r\n);\r\n\r\nif (targetObj) {\r\n  targetObj[receiverKey] = newValue;\r\n} else {\r\n  console.warn(\\`[ST-VarSystem] SELECT_SET: 未找到匹配对象 \\${selectorKey}=\\${selectorValue}\\`);\r\n}\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== SELECT_ADD (SAM 特有) ====================\r\n    {\r\n      id: \"builtin-select-add\",\r\n      name: \"SELECT_ADD\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 70,\r\n      builtin: true,\r\n      description:\r\n        '在数组中查找对象并增加其属性值。语法: @.SELECT_ADD(\"path\", \"selectorKey\", \"selectorValue\", \"receiverKey\", valueToAdd);',\r\n      executor: `\r\n// SELECT_ADD(path, selectorKey, selectorValue, receiverKey, valueToAdd) - SAM\r\nconst [path, selectorKey, selectorValue, receiverKey, valueToAddStr] = args;\r\n\r\nconst arr = _.get(snapshot, path);\r\nif (!Array.isArray(arr)) {\r\n  console.warn('[ST-VarSystem] SELECT_ADD: 目标不是数组:', path);\r\n  return snapshot;\r\n}\r\n\r\n// 查找匹配的对象\r\nconst targetObj = arr.find(item => \r\n  item && typeof item === 'object' && item[selectorKey] === selectorValue\r\n);\r\n\r\nif (!targetObj) {\r\n  console.warn(\\`[ST-VarSystem] SELECT_ADD: 未找到匹配对象 \\${selectorKey}=\\${selectorValue}\\`);\r\n  return snapshot;\r\n}\r\n\r\nconst currentValue = targetObj[receiverKey];\r\n\r\n// 如果是数组，追加元素\r\nif (Array.isArray(currentValue)) {\r\n  let value;\r\n  try {\r\n    value = JSON.parse(valueToAddStr);\r\n  } catch (e) {\r\n    value = valueToAddStr.replace(/^[\"']|[\"']$/g, '');\r\n  }\r\n  currentValue.push(value);\r\n} else {\r\n  // 否则作为数值加法\r\n  const num = parseFloat(valueToAddStr);\r\n  if (isNaN(num)) {\r\n    console.warn('[ST-VarSystem] SELECT_ADD: 无效的数值参数:', valueToAddStr);\r\n    return snapshot;\r\n  }\r\n  targetObj[receiverKey] = (parseFloat(currentValue) || 0) + num;\r\n}\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== SELECT_DEL (SAM 特有) ====================\r\n    {\r\n      id: \"builtin-select-del\",\r\n      name: \"SELECT_DEL\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 80,\r\n      builtin: true,\r\n      description:\r\n        '在数组中查找并删除匹配的对象。语法: @.SELECT_DEL(\"path\", \"selectorKey\", \"selectorValue\");',\r\n      executor: `\r\n// SELECT_DEL(path, selectorKey, selectorValue) - SAM\r\nconst [path, selectorKey, selectorValue] = args;\r\n\r\nconst arr = _.get(snapshot, path);\r\nif (!Array.isArray(arr)) {\r\n  console.warn('[ST-VarSystem] SELECT_DEL: 目标不是数组:', path);\r\n  return snapshot;\r\n}\r\n\r\n// 查找匹配对象的索引\r\nconst index = arr.findIndex(item => \r\n  item && typeof item === 'object' && item[selectorKey] === selectorValue\r\n);\r\n\r\nif (index !== -1) {\r\n  arr.splice(index, 1);\r\n} else {\r\n  console.warn(\\`[ST-VarSystem] SELECT_DEL: 未找到匹配对象 \\${selectorKey}=\\${selectorValue}\\`);\r\n}\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== INC (MVU 特有) ====================\r\n    {\r\n      id: \"builtin-inc\",\r\n      name: \"INC\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 90,\r\n      builtin: true,\r\n      description:\r\n        '数值自增（默认 +1）。语法: @.INC(\"path\") 或 @.INC(\"path\", step);',\r\n      executor: `\r\n// INC(path, step?) - 数值自增（MVU）\r\nconst [path, stepStr] = args;\r\nconst step = stepStr ? parseFloat(stepStr) : 1;\r\n\r\nif (isNaN(step)) {\r\n  console.warn('[ST-VarSystem] INC: 无效的步进值:', stepStr);\r\n  return snapshot;\r\n}\r\n\r\nconst currentValue = _.get(snapshot, path, 0);\r\nconst newValue = (parseFloat(currentValue) || 0) + step;\r\n_.set(snapshot, path, newValue);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== DEC (MVU 特有) ====================\r\n    {\r\n      id: \"builtin-dec\",\r\n      name: \"DEC\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 100,\r\n      builtin: true,\r\n      description:\r\n        '数值自减（默认 -1）。语法: @.DEC(\"path\") 或 @.DEC(\"path\", step);',\r\n      executor: `\r\n// DEC(path, step?) - 数值自减（MVU）\r\nconst [path, stepStr] = args;\r\nconst step = stepStr ? parseFloat(stepStr) : 1;\r\n\r\nif (isNaN(step)) {\r\n  console.warn('[ST-VarSystem] DEC: 无效的步进值:', stepStr);\r\n  return snapshot;\r\n}\r\n\r\nconst currentValue = _.get(snapshot, path, 0);\r\nconst newValue = (parseFloat(currentValue) || 0) - step;\r\n_.set(snapshot, path, newValue);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n\r\n    // ==================== DELETE (MVU 特有) ====================\r\n    {\r\n      id: \"builtin-delete\",\r\n      name: \"DELETE\",\r\n      type: \"active\",\r\n      enabled: true,\r\n      order: 110,\r\n      builtin: true,\r\n      description: '删除变量。语法: @.DELETE(\"path\");',\r\n      executor: `\r\n// DELETE(path) - 删除变量（MVU）\r\nconst [path] = args;\r\n\r\n_.unset(snapshot, path);\r\n\r\nreturn snapshot;\r\n`,\r\n    },\r\n  ];\r\n}\r\n\r\n/**\r\n * 初始化内置函数库到注册表\r\n * @param {import('./registry.js').FunctionRegistry} registry\r\n */\r\nexport function initBuiltinFunctions(registry) {\r\n  const builtins = getBuiltinFunctions();\r\n\r\n  for (const func of builtins) {\r\n    registry.upsertGlobalFunction(func);\r\n  }\r\n\r\n  console.log(\"[ST-VarSystemExtension] 已注册\", builtins.length, \"个内置函数\");\r\n  console.log(\r\n    \"[ST-VarSystemExtension] MVU 兼容函数: SET, ADD, SUB, APPEND, REMOVE, INC, DEC, DELETE\",\r\n  );\r\n  console.log(\r\n    \"[ST-VarSystemExtension] SAM 兼容函数: SET, ADD, DEL, SELECT_SET, SELECT_ADD, SELECT_DEL\",\r\n  );\r\n}\r\n"],"names":["getBuiltinFunctions","id","name","type","enabled","order","builtin","description","executor","initBuiltinFunctions","registry","builtins","func","upsertGlobalFunction","console","log","length"],"mappings":"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"}