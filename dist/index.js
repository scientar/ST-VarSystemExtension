import{extension_settings as t,getContext as e,writeExtensionField as n,renderExtensionTemplateAsync as o}from'../../../../../public/scripts/extensions.js';import{getRequestHeaders as s,eventSource as r,event_types as a,saveSettingsDebounced as i,saveChat as c}from'../../../../../public/script.js';import{callGenericPopup as l,POPUP_TYPE as d}from'../../../../../public/scripts/popup.js';import'../../../../../public/scripts/i18n.js';const u=new Map,f=new Map,p=new Map;function y(t={}){const{container:e,containerId:n,initialValue:o,styleUrl:s,scriptUrl:r,readOnly:a=!1,onChange:i,onFallback:c,onReady:l,defaultMode:d=null}=t;let y=b(e,n),h=null,m=null,g=!1,v=x(o??{}),w=null,S=!1;function b(t,e){return t instanceof HTMLElement?t:'string'==typeof t?document.getElementById(t):'string'==typeof e?document.getElementById(e):null}function x(t){if(null==t)return t;if('function'==typeof structuredClone)try{return structuredClone(t)}catch(e){return JSON.parse(JSON.stringify(t))}return JSON.parse(JSON.stringify(t))}function T(t,{silent:e=!1}={}){const n=null==t?{}:t;if(v=x(n),g&&h){e&&(S=!0);try{h.set({json:x(n)})}catch(E){console.error('[VariableBlockEditor] 设置编辑内容失败',E)}e&&(S=!1)}else w=x(n)}return{ensureReady:async function(){if(h)return h;if(y=y||b(e,n),!y)return null;try{await function(t){if(!t)return Promise.resolve();if(u.has(t))return u.get(t);if(document.querySelector(`link[data-jsoneditor-style="${CSS.escape(t)}"]`))return u.set(t,Promise.resolve()),u.get(t);const e=new Promise((e,n)=>{const o=document.createElement('link');o.rel='stylesheet',o.href=t,o.dataset.jsoneditorStyle=t,o.addEventListener('load',()=>e()),o.addEventListener('error',e=>{o.remove(),u.delete(t),n(e)}),document.head.appendChild(o)});return u.set(t,e),e}(s);const t=await function(t){if(!t)return Promise.resolve({createJSONEditor:globalThis.createJSONEditor});if(p.get(t))return Promise.reject(new Error('JSON 编辑器模块加载已失败'));if(f.has(t))return f.get(t);const e=import(t).then(t=>{if(!t?.createJSONEditor&&!globalThis.createJSONEditor)throw new Error('JSON 编辑器模块未提供 createJSONEditor');return t}).catch(e=>{throw f.delete(t),p.set(t,!0),e});return f.set(t,e),e}(r),e=t?.createJSONEditor??globalThis.createJSONEditor;if('function'!=typeof e)throw new Error('JSON 编辑器模块未提供 createJSONEditor');const n=localStorage.getItem('varSystemEditorMode');if(h=e({target:y,props:{content:{json:v??{}},mode:n||d||'text',mainMenuBar:!0,navigationBar:!1,statusBar:!1,readOnly:a,onChange:(t,e,n)=>{S||(v=x(t?.json??v??{}),'function'==typeof i&&i(t,e,n))}}}),g=!0,!h||'function'!=typeof h.set)throw new Error('JSON 编辑器实例缺少 set 方法');return h.isFallback=!1,null!==w&&(T(w,{silent:!0}),w=null),'function'==typeof l&&l(h),h}catch(E){return console.error('[VariableBlockEditor] 初始化 JSON 编辑器失败',E),function(){if(y=y||b(e,n),!y)return null;if(m)return m;y.innerHTML='',y.style.display='flex',y.style.flexDirection='column',y.style.alignItems='stretch';const o=document.createElement('div');o.style.fontSize='12px',o.style.padding='6px',o.style.background='rgba(255, 255, 255, 0.05)',o.style.borderBottom='1px solid var(--SmartThemeBorderColor, #333)',o.textContent='JSON 编辑器资源加载失败，已降级为纯文本模式。';const s=document.createElement('textarea');s.style.width='100%',s.style.height='calc(100% - 32px)',s.style.minHeight='220px',s.style.background='transparent',s.style.color='inherit',s.style.border='none',s.style.padding='10px',s.style.resize='vertical',s.style.fontFamily='var(--monospaceFont, monospace)',s.style.fontSize='13px',s.style.lineHeight='1.4',s.style.borderRadius='0',s.readOnly=Boolean(a),y.appendChild(o),y.appendChild(s);const r=()=>{if(S)return;let e;const n=[];if(0===s.value.trim().length)e={};else try{e=JSON.parse(s.value)}catch(t){n.push({message:t?.message??String(t)})}const o=n.length>0?{json:void 0}:{json:e};v=x(o?.json??v??{}),'function'==typeof i&&i(o,null,{contentErrors:n})};s.addEventListener('input',r),m={isFallback:!0,set({json:t}){S=!0;try{const e=null==t?{}:t;s.value=JSON.stringify(e,null,2)}catch(e){s.value='{}'}S=!1},get(){try{return{json:s.value.trim().length?JSON.parse(s.value):{}}}catch(t){return{json:void 0}}},destroy(){s.removeEventListener('input',r),y.innerHTML=''}},h=m,g=!0;const l=null!==w?w:v??{};m.set({json:l}),w=null,'function'==typeof c&&c();return m}()}},setValue:T,getValue:function(){if(!h)return x(v??{});try{const t=h.get();if(void 0!==t?.json)return x(t.json)}catch(E){console.error('[VariableBlockEditor] 读取编辑内容失败',E)}return x(v??{})},set:function(t){if(h&&'function'==typeof h.set)return h.set(t);void 0!==t?.json&&T(t.json)},get:function(){return h&&'function'==typeof h.get?h.get():{json:x(v??{})}},setMode:function(t){h&&'function'==typeof h.updateProps?(localStorage.setItem('varSystemEditorMode',t),h.updateProps({mode:t})):console.warn('[VariableBlockEditor] 编辑器未初始化或不支持 updateProps')},getMode:function(){return localStorage.getItem('varSystemEditorMode')},destroy:function(){if(g){try{h?.destroy?.()}catch(E){console.error('[VariableBlockEditor] 销毁编辑器失败',E)}h=null,m=null,g=!1,y=null}},isFallback:function(){return Boolean(m)},setContainer:function(t){y=b(t,n)}}}const h={},m=function(t,e,n){let o=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName('link');const t=document.querySelector('meta[property=csp-nonce]'),n=t?.nonce||t?.getAttribute('nonce');s=e.map(t=>{if((t=function(t){return'/'+t}(t))in h)return;h[t]=!0;const e=t.endsWith('.css'),o=e?'[rel="stylesheet"]':'';if(document.querySelector(`link[href="${t}"]${o}`))return;const s=document.createElement('link');return s.rel=e?'stylesheet':'modulepreload',e||(s.as='script'),s.crossOrigin='',s.href=t,n&&s.setAttribute('nonce',n),document.head.appendChild(s),e?new Promise((e,n)=>{s.addEventListener('load',e),s.addEventListener('error',()=>n(new Error(`Unable to preload CSS for ${t}`)))}):void 0}),o=Promise.all(s.map(t=>Promise.resolve(t).then(t=>({status:'fulfilled',value:t}),t=>({status:'rejected',reason:t}))))}var s;function r(t){const e=new Event('vite:preloadError',{cancelable:!0});if(e.payload=t,window.dispatchEvent(e),!e.defaultPrevented)throw t}return o.then(e=>{for(const t of e||[])'rejected'===t.status&&r(t.reason);return t().catch(r)})},g='[ST-VarSystemExtension]',v=(...t)=>console.log(g,...t),w=(...t)=>console.warn(g,...t),E=(...t)=>console.error(g,...t),S='[ST-VarSystemExtension]';const b=new class{constructor(){this.safeGlobals={_:window._,Object:Object,Array:Array,String:String,Number:Number,Boolean:Boolean,Math:Math,Date:Date,JSON:JSON,parseInt:parseInt,parseFloat:parseFloat,isNaN:isNaN,isFinite:isFinite,console:{log:console.log.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)}}}compileExecutor(t){try{const e=['snapshot','args','context',...Object.keys(this.safeGlobals)];return new Function(...e,t)}catch(e){return E(`${S} 编译函数失败:`,e),null}}executeFunction(t,e,n=[],o={}){try{const s=this.compileExecutor(t.executor);if(!s)return{success:!1,snapshot:e,error:'函数编译失败'};const r=JSON.parse(JSON.stringify(e)),a=s(...[r,n,o,...Object.values(this.safeGlobals)]);return null==a?(w(`${S} 函数 ${t.name} 未返回快照，使用原快照`),{success:!0,snapshot:r}):{success:!0,snapshot:a}}catch(s){return E(`${S} 执行函数 ${t.name} 失败:`,s),{success:!1,snapshot:e,error:s.message||String(s)}}}executeAll(t,e,n,o){let s=JSON.parse(JSON.stringify(t));const r=[];v(`${S} 执行 ${n.before.length} 个前置被动函数`);for(const a of n.before){const t=this.executeFunction(a,s,[],o);t.success?s=t.snapshot:r.push({functionName:a.name,error:t.error||'未知错误'})}v(`${S} 执行 ${e.length} 个主动函数调用`);for(const a of e){const t=this.executeFunction(a.functionDef,s,a.args,o);t.success?s=t.snapshot:r.push({functionName:a.functionDef.name,error:t.error||'未知错误'})}v(`${S} 执行 ${n.after.length} 个后置被动函数`);for(const a of n.after){const t=this.executeFunction(a,s,[],o);t.success?s=t.snapshot:r.push({functionName:a.name,error:t.error||'未知错误'})}return r.length>0&&(w(`${S} 有 ${r.length} 个函数调用失败:`,r),window.toastr&&window.toastr.warning(`本次解析有 ${r.length} 个函数调用失败，请检查控制台日志`,'变量系统')),{snapshot:s,errors:r}}};async function x(t,e){const{functionRegistry:n}=await m(async()=>{const{functionRegistry:t}=await Promise.resolve().then(()=>B);return{functionRegistry:t}},[]),o=n.getPassiveFunctions(),s={timestamp:Date.now()};return b.executeAll(e,t,o,s).snapshot}const T='[ST-VarSystemExtension]';class C{constructor(){this.globalFunctions=new Map,this.localFunctions=new Map}loadGlobalFunctions(t){if(this.globalFunctions.clear(),Array.isArray(t)){for(const e of t)this.validateFunction(e)?this.globalFunctions.set(e.id,e):w(`${T} 跳过无效的全局函数:`,e);v(`${T} 已加载 ${this.globalFunctions.size} 个全局函数`)}else w(`${T} 全局函数库格式错误，应为数组`)}loadLocalFunctions(t){if(this.localFunctions.clear(),Array.isArray(t)){for(const e of t)this.validateFunction(e)?this.localFunctions.set(e.id,e):w(`${T} 跳过无效的本地函数:`,e);v(`${T} 已加载 ${this.localFunctions.size} 个本地函数`)}}validateFunction(t){if(!t||'object'!=typeof t)return!1;if(!t.id||'string'!=typeof t.id)return!1;if(!t.name||'string'!=typeof t.name)return!1;if(!['active','passive'].includes(t.type))return!1;if('boolean'!=typeof t.enabled)return!1;if('number'!=typeof t.order)return!1;if(!t.executor||'string'!=typeof t.executor)return!1;if('active'===t.type){if(!t.pattern||'string'!=typeof t.pattern)return!1;try{new RegExp(t.pattern)}catch(e){return E(`${T} 函数 ${t.name} 的正则表达式无效:`,e),!1}}return!('passive'===t.type&&!['before_active','after_active'].includes(t.timing))}getEnabledFunctions(){const t=new Map;for(const[e,n]of this.globalFunctions)n.enabled&&t.set(e,n);for(const[e,n]of this.localFunctions)n.enabled&&t.set(e,n);return Array.from(t.values())}getActiveFunctions(){return this.getEnabledFunctions().filter(t=>'active'===t.type).sort((t,e)=>t.order-e.order)}getPassiveFunctions(){const t=this.getEnabledFunctions().filter(t=>'passive'===t.type);return{before:t.filter(t=>'before_active'===t.timing).sort((t,e)=>t.order-e.order),after:t.filter(t=>'after_active'===t.timing).sort((t,e)=>t.order-e.order)}}parseFunctionCalls(t){const e=this.getActiveFunctions(),n=[];for(const s of e)try{const e=new RegExp(s.pattern,'g');let o=e.exec(t);for(;null!==o;)n.push({functionDef:s,args:o.slice(1),index:o.index,fullMatch:o[0]}),o=e.exec(t)}catch(o){E(`${T} 函数 ${s.name} 匹配失败:`,o)}return n.sort((t,e)=>t.index-e.index),v(`${T} 从消息中解析到 ${n.length} 个函数调用`),n}getFunction(t){return this.localFunctions.get(t)||this.globalFunctions.get(t)||null}upsertGlobalFunction(t){if(!this.validateFunction(t))throw new Error('函数定义无效');this.globalFunctions.set(t.id,t)}upsertLocalFunction(t){if(!this.validateFunction(t))throw new Error('函数定义无效');this.localFunctions.set(t.id,t)}deleteFunction(t,e){'global'===e?this.globalFunctions.delete(t):'local'===e&&this.localFunctions.delete(t)}exportGlobalFunctions(){return Array.from(this.globalFunctions.values())}exportLocalFunctions(){return Array.from(this.localFunctions.values())}}const I=new C,B=Object.freeze(Object.defineProperty({__proto__:null,FunctionRegistry:C,functionRegistry:I},Symbol.toStringTag,{value:'Module'}));function k(t){return!!t&&(!1===t.is_user||'assistant'===t.role)}function A(t){return t?t.swipe_id??0:0}const F='st_var_system_snapshot_id';function j(t){if(!t)return null;const e=A(t);if(!Array.isArray(t.swipes_info))return null;const n=t.swipes_info[e];if(!n)return null;const o=n[F];return'string'==typeof o?o:null}async function L(t){if(!t)return console.error('[ST-VarSystemExtension] loadSnapshot: identifier 为空'),null;try{const e=await fetch(`/api/plugins/var-manager/var-manager/snapshots/${t}`,{method:'GET',headers:{'Content-Type':'application/json'}});if(!e.ok){if(404===e.status)return console.warn(`[ST-VarSystemExtension] 快照不存在: ${t}`),null;throw new Error(`HTTP ${e.status}: ${e.statusText}`)}return await e.json()}catch(E){return console.error(`[ST-VarSystemExtension] 加载快照失败: ${t}`,E),null}}async function O(t,e,n){try{const o=window.SillyTavern.getContext(),r=o.getCurrentChatId?.()||o.chatId;if(!r)return console.warn('[ST-VarSystemExtension] saveSnapshotToPlugin: 无法获取聊天文件名'),null;const a=o.chat;if(!a||t>=a.length)return console.error('[ST-VarSystemExtension] saveSnapshotToPlugin: 消息 ID 无效',{messageId:t,chatLength:a?.length}),null;const i=a[t];if(!i)return console.error('[ST-VarSystemExtension] saveSnapshotToPlugin: 消息不存在',t),null;const c='undefined'!=typeof crypto&&'function'==typeof crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).substring(2,15)}`,l=await async function(t){const{chatFile:e,messageId:n,payload:o,identifier:r}=t;if(!e||void 0===n||!o)return console.error('[ST-VarSystemExtension] saveSnapshot: 缺少必要参数',t),null;try{const t=await fetch('/api/plugins/var-manager/var-manager/snapshots',{method:'POST',headers:{...s(),'Content-Type':'application/json'},body:JSON.stringify({chatFile:e,messageId:String(n),payload:o,identifier:r})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(E){return console.error('[ST-VarSystemExtension] 保存快照失败',t,E),null}}({chatFile:r,messageId:t,payload:n,identifier:c});if(!l)return console.warn('[ST-VarSystemExtension] saveSnapshotToPlugin: 插件保存失败（插件可能不可用）'),null;if(!function(t,e,n=null){if(!t||'string'!=typeof e)return!1;const o=null!==n?n:A(t);return Array.isArray(t.swipes_info)||(t.swipes_info=[]),t.swipes_info[o]||(t.swipes_info[o]={}),t.swipes_info[o][F]=e,!0}(i,c,e))return console.error('[ST-VarSystemExtension] saveSnapshotToPlugin: 写入快照标识符失败',{messageId:t,swipeId:e}),null;const d=null!==e?e:A(i);return console.log(`[ST-VarSystemExtension] 快照已保存: 消息 #${t}, swipe=${d}, ID=${c}`),c}catch(E){return console.error('[ST-VarSystemExtension] saveSnapshotToPlugin 失败:',E),null}}const N='[ST-VarSystemExtension/variableInjector]';async function D(t){if(t&&'object'==typeof t)if('undefined'!=typeof window&&window.TavernHelper&&'function'==typeof window.TavernHelper.updateVariablesWith)try{await window.TavernHelper.updateVariablesWith(e=>(e.vs_stat_data=t,e),{type:'chat'}),console.log(N,'快照已注入到 vs_stat_data 变量')}catch(E){console.error(N,'注入快照变量时发生错误:',E)}else console.error(N,'酒馆助手 (JS-Slash-Runner) 未安装或 API 不可用。','变量系统依赖酒馆助手提供的 updateVariablesWith API。','请安装扩展: https://github.com/ShinoKana/JS-Slash-Runner');else console.warn(N,'快照数据无效，跳过注入:',t)}const M='[ST-VarSystemExtension/processor]';function V(){try{const t=window.SillyTavern.getContext(),e=t.characters[t.characterId];if(!e?.data?.extensions?.st_var_system)return console.log(M,'角色未配置变量模板'),null;const{enabled:n,templateBody:o}=e.data.extensions.st_var_system;return n?o&&'object'==typeof o?(console.log(M,'使用角色模板作为初始快照:',Object.keys(o)),structuredClone(o)):(console.warn(M,'角色模板格式无效:',o),null):(console.log(M,'角色变量模板未启用'),null)}catch(E){return console.error(M,'读取角色模板时发生错误:',E),null}}async function P(t){try{const e=await fetch(`/api/plugins/var-manager/var-manager/snapshots/${t}`);if(404===e.status)return console.warn(M,`快照不存在: ${t}`),null;if(!e.ok)return console.error(M,`读取快照失败 (${e.status}): ${t}`),null;return(await e.json()).payload}catch(E){return console.error(M,'从插件读取快照时发生错误:',E),null}}async function R(t,e=null){console.log(M,`开始处理消息 #${t}, swipe=${e??'current'}`);const n=window.SillyTavern.getContext().chat;if(!n||0===n.length)return console.warn(M,'当前无聊天记录'),null;const o=await async function(t,e=null){const n=window.SillyTavern.getContext().chat;if(!n||t>=n.length)return console.error(M,'checkExistingSnapshot: 消息 ID 无效',{messageId:t,chatLength:n?.length}),null;const o=n[t];if(!o)return console.error(M,'checkExistingSnapshot: 消息不存在',t),null;const s=j(o);if(!s)return null;console.log(M,`消息 #${t} swipe=${e??'current'} 已有快照: ${s}`);const r=await P(s);return r?{snapshotId:s,snapshot:r}:(console.warn(M,`快照 ID 存在但无法从插件读取，将重新生成: ${s}`),null)}(t,e);if(o?.snapshot)return await D(o.snapshot),console.log(M,'消息已有快照，直接注入'),o.snapshot;const s=await async function(t,e){if(!Array.isArray(e)||t<0||t>=e.length)return console.error('[ST-VarSystemExtension] findSnapshotAnchor: 参数无效',{startMessageId:t,chatLength:e?.length}),null;for(let n=t;n>=0;n--){const t=e[n];if(!k(t))continue;const o=j(t);if(!o)continue;console.log(`[ST-VarSystemExtension] 找到快照锚点: 第 ${n} 层, ID: ${o}`);const s=await L(o);if(s)return{anchorMessageId:n,snapshotId:o,snapshot:s.payload};console.warn(`[ST-VarSystemExtension] 快照标识符存在但数据丢失: ${o}, 将清除该标识符`)}return console.log('[ST-VarSystemExtension] 未找到快照锚点,需要使用角色模板'),null}(t,n);let r,a;s?(console.log(M,`找到快照锚点: 消息 #${s.anchorMessageId}, ID: ${s.snapshotId}`),r=await P(s.snapshotId),r?a=s.anchorMessageId+1:(console.warn(M,`锚点快照读取失败，将从角色模板重新开始: ${s.snapshotId}`),r=V()||{},a=0)):(console.log(M,'未找到快照锚点，使用角色模板'),r=V(),r||(console.warn(M,'无角色模板且无快照锚点，使用空快照'),r={}),a=0);const i=function(t,e,n){if(!Array.isArray(n))return console.error('[ST-VarSystemExtension] getAIMessageRange: chat 不是数组'),[];if(t<0||e>=n.length||t>e)return console.error('[ST-VarSystemExtension] getAIMessageRange: 范围无效',{startId:t,endId:e,chatLength:n.length}),[];const o=[];for(let s=t;s<=e;s++){const t=n[s];if(!k(t))continue;const e=t.swipe_id??0,r=Array.isArray(t.swipes)?t.swipes[e]:t.mes||'';o.push({messageId:s,message:t,content:r})}return o}(a,t,n);if(0===i.length)return console.log(M,'无需处理的 AI 消息，直接使用基础快照'),await D(r),r;console.log(M,`需要处理 ${i.length} 条 AI 消息`);let c=structuredClone(r);for(let l=0;l<i.length;l++){const t=i[l],n=l===i.length-1;console.log(M,`处理第 ${l+1}/${i.length} 层: 消息 #${t.messageId}`);const o=t.content||t.mes||'',s=I.parseFunctionCalls(o);if(s.length>0){console.log(M,`消息 #${t.messageId} 解析到 ${s.length} 个函数调用`);try{c=await x(s,c),console.log(M,`消息 #${t.messageId} 函数执行完成`)}catch(E){console.error(M,`消息 #${t.messageId} 执行函数时发生错误:`,E)}}else console.log(M,`消息 #${t.messageId} 无函数调用，快照不变`);const r=n?e:t.message?.swipe_id??null,a=await O(t.messageId,r,c);a?console.log(M,`消息 #${t.messageId} 快照已保存，ID: ${a}`):console.warn(M,`消息 #${t.messageId} 保存快照到插件失败（插件可能不可用）`)}return await D(c),console.log(M,'处理完成，已注入快照变量'),c}async function J(t){const e=window.SillyTavern.getContext().chat;if(!e||0===e.length)return void console.warn(M,'当前无聊天记录，无法重新处理');const n=e.length-1;console.log(M,`重新处理消息 #${t} 到 #${n}`);for(let o=t;o<=n;o++){const t=e[o];!1!==t.is_user&&'assistant'!==t.role||await R(o)}console.log(M,'重新处理完成')}const H='[ST-VarSystemExtension/listeners]';let G=null;function U(){try{const t=window.SillyTavern.getContext(),e=t.characters?.[t.characterId];return!0===e?.data?.extensions?.st_var_system?.enabled}catch(E){return console.error(H,'检查启用状态时发生错误:',E),!1}}async function q(t){if(console.log(H,`MESSAGE_RECEIVED: 消息 #${t}`),U())try{await R(t)}catch(E){console.error(H,'MESSAGE_RECEIVED 处理失败:',E)}else console.log(H,'变量系统未启用，跳过处理')}async function X(t){if(console.log(H,`MESSAGE_SWIPED: 消息 #${t}`),U())try{const e=window.SillyTavern.getContext().chat[t],n=e?.swipe_id??null;console.log(H,`当前 swipe ID: ${n}`),await R(t,n)}catch(E){console.error(H,'MESSAGE_SWIPED 处理失败:',E)}else console.log(H,'变量系统未启用，跳过处理')}async function W(t){console.log(H,`CHAT_CHANGED: ${t}`);try{if(!U())return void console.log(H,'新角色未启用变量系统');const t=window.SillyTavern.getContext().chat;if(!t||0===t.length)return void console.log(H,'新聊天无消息');for(let e=t.length-1;e>=0;e--){const n=t[e];if(!1===n.is_user||'assistant'===n.role){console.log(H,`处理最后一条 AI 消息: #${e}`),await R(e);break}}}catch(E){console.error(H,'CHAT_CHANGED 处理失败:',E)}}async function Q(t){if(console.log(H,`MESSAGE_DELETED: 消息 #${t}`),U())try{const e=window.SillyTavern.getContext().chat;if(!e||0===e.length)return void console.log(H,'聊天已清空，无需重新处理');console.log(H,`从消息 #${t} 开始重新处理`),await J(t)}catch(E){console.error(H,'MESSAGE_DELETED 处理失败:',E)}else console.log(H,'变量系统未启用，跳过处理')}async function Y(t){console.log(H,`CHAT_DELETED: ${t}`);try{if(!t)return void console.warn(H,'聊天文件名为空，无法删除快照');const e=await async function(){if(window.token||globalThis.token)return window.token||globalThis.token;if(G)return G;try{const t=await fetch('/csrf-token');if(t.ok){const e=await t.json();return G=e.token,G}}catch(E){console.error(H,'获取 CSRF token 失败:',E)}return null}();if(!e)return void console.warn(H,'无法获取 CSRF Token，跳过插件删除');const n=`/api/plugins/var-manager/var-manager/snapshots/by-chat/${encodeURIComponent(t)}`,o=await fetch(n,{method:'DELETE',headers:{'X-CSRF-Token':e}});if(404===o.status)return void console.log(H,'插件不可用或快照不存在，跳过数据库清理');if(!o.ok)return void console.error(H,`删除聊天快照失败 (${o.status}): ${t}`);const s=await o.json();console.log(H,`已删除聊天 "${t}" 的 ${s.deletedCount??0} 条快照`)}catch(E){console.error(H,'CHAT_DELETED 处理失败:',E)}}const K='[ST-VarSystemExtension/FunctionLibrary]',Z='st_var_system';let tt='global';async function et(){console.log(K,'初始化函数库界面');const{initBuiltinFunctions:n}=await m(async()=>{const{initBuiltinFunctions:t}=await import('./builtins.CaK7DaWc.chunk.js');return{initBuiltinFunctions:t}},[]);n(I),console.log(K,'内置函数已注册'),await async function(){try{const n=t[Z]?.functions||[];I.loadGlobalFunctions(n);const o=e();if(void 0!==o.characterId){const t=o.characters[o.characterId],e=t?.data?.extensions?.[Z]?.functions||[];I.loadLocalFunctions(e)}}catch(E){console.error(K,'加载函数失败:',E)}}(),$('input[name="function-scope"]').on('change',async t=>{tt=t.target.value,await nt()}),$('#var-system-new-function-btn').on('click',async()=>{await st()}),$('#var-system-import-functions-btn').on('click',async()=>{await async function(){const t=$('<input type="file" accept=".json">');t.on('change',async t=>{const e=t.target.files[0];if(e)try{const t=await e.text(),n=JSON.parse(t);if(!n.version||!Array.isArray(n.functions))return void toastr.error('无效的函数库文件格式');let o=0;for(const e of n.functions){const t={...e,id:it(),enabled:!1};'global'===tt?I.upsertGlobalFunction(t):I.upsertLocalFunction(t),o++}await rt(),await nt(),toastr.success(`成功导入 ${o} 个函数`)}catch(E){console.error(K,'导入函数失败:',E),toastr.error(`导入失败：${E.message}`)}}),t.trigger('click')}()}),$('#var-system-export-functions-btn').on('click',async()=>{await async function(){const t='global'===tt?I.exportGlobalFunctions():I.exportLocalFunctions();if(!t||0===t.length)return void toastr.warning('没有可导出的函数');const e={version:'1.0',functions:t},n=JSON.stringify(e,null,2),o=new Blob([n],{type:'application/json'}),s=URL.createObjectURL(o),r=$('<a>');r.attr('href',s),r.attr('download',`var-system-functions-${tt}-${Date.now()}.json`),r[0].click(),URL.revokeObjectURL(s),toastr.success('函数库已导出')}()}),$('#var-system-generate-prompt-btn').on('click',async()=>{await async function(){const t=await I.getEnabledFunctions('active');if(!t||0===t.length)return void toastr.warning('没有启用的主动函数');let e='<variable_system_functions>\n你可以使用以下函数来更新游戏状态：\n\n';for(const s of t)if(e+=`${s.name} // ${s.description||'无说明'}\n`,s.pattern){const t=at(s.pattern,s.name);e+=`示例：${t}\n\n`}e+='</variable_system_functions>';const n=$('#var-system-prompt-generator-template').html(),o=$(n);o.find('#generated-prompt-content').text(e),o.find('#copy-prompt-btn').on('click',()=>{navigator.clipboard.writeText(e),toastr.success('已复制到剪贴板')}),await l(o,d.DISPLAY,'函数调用提示词',{wide:!0})}()}),await nt()}async function nt(){const t=$('#var-system-function-list');t.empty();const e='global'===tt?I.exportGlobalFunctions():I.exportLocalFunctions();if(e&&0!==e.length){for(const n of e){const e=ot(n);t.append(e)}!function(){const t=$('#var-system-function-list');t.sortable('instance')&&t.sortable('destroy');t.sortable({items:'.var-system-function-card',handle:'.drag-handle',cursor:'move',tolerance:'pointer',placeholder:'var-system-sortable-placeholder',stop:async()=>{await async function(){const t=$('#var-system-function-list .var-system-function-card'),e=[];t.each(function(t){const n=$(this).attr('data-function-id');e.push({id:n,order:t})});const n='global'===tt?I.exportGlobalFunctions():I.exportLocalFunctions(),o=[];for(const s of e){const t=n.find(t=>t.id===s.id);t&&(t.order=s.order,o.push(t))}'global'===tt?I.loadGlobalFunctions(o):I.loadLocalFunctions(o);await rt(),console.log(K,'函数顺序已更新')}()}})}()}else t.html('\n      <div class="var-system-empty-state">\n        <i class="fa-solid fa-inbox fa-3x"></i>\n        <p>暂无函数</p>\n        <p class="var-system-hint">点击"新增函数"创建你的第一个函数</p>\n      </div>\n    ')}function ot(t){const e=$('#var-system-function-card-template').html(),n=$(e);n.attr('data-function-id',t.id),n.find('.function-enabled-checkbox').prop('checked',t.enabled),n.find('.function-enabled-checkbox').on('change',async e=>{t.enabled=e.target.checked,await rt()}),n.find('.var-system-function-name').text(t.name);const o=n.find('.var-system-badge');if('active'===t.type?o.removeClass('var-system-badge-passive').addClass('var-system-badge-active').text('主动'):o.removeClass('var-system-badge-active').addClass('var-system-badge-passive').text('被动'),n.find('.var-system-function-description').text(t.description||'无说明'),'passive'===t.type){const e='before_active'===t.timing?'主动函数前执行':'主动函数后执行';n.find('.var-system-function-order').text(e)}else n.find('.var-system-function-order').remove();return n.find('.function-edit-btn').on('click',async()=>{await st(t)}),n.find('.function-delete-btn').on('click',async()=>{await async function(t){const e=await l(`确定要删除函数"${t.name}"吗？`,d.CONFIRM,'',{okButton:'删除',cancelButton:'取消'});if(e!==ct.AFFIRMATIVE)return;I.deleteFunction(t.id,tt),await rt(),await nt(),toastr.success(`函数"${t.name}"已删除`)}(t)}),n}async function st(t=null){const e=$('#var-system-function-editor-template').html(),n=$(e);t&&(n.find('#function-name-input').val(t.name),n.find('#function-type-select').val(t.type),n.find('#function-enabled-checkbox').prop('checked',t.enabled),n.find('#function-description-textarea').val(t.description||''),n.find('#function-pattern-input').val(t.pattern||''),n.find('#function-timing-select').val(t.timing||'before_active'),n.find('#function-executor-textarea').val(t.executor||''));const o=()=>{'active'===n.find('#function-type-select').val()?(n.find('.var-system-active-only').show(),n.find('.var-system-passive-only').hide()):(n.find('.var-system-active-only').hide(),n.find('.var-system-passive-only').show())};n.find('#function-type-select').on('change',o),o();if(await l(n,d.CONFIRM,t?'编辑函数':'新增函数',{okButton:'保存',cancelButton:'取消'})!==ct.AFFIRMATIVE)return;const s={id:t?.id||it(),name:n.find('#function-name-input').val().trim(),type:n.find('#function-type-select').val(),enabled:n.find('#function-enabled-checkbox').prop('checked'),description:n.find('#function-description-textarea').val().trim(),executor:n.find('#function-executor-textarea').val().trim()};'active'===s.type?s.pattern=n.find('#function-pattern-input').val().trim():s.timing=n.find('#function-timing-select').val(),s.name?s.executor?'active'!==s.type||s.pattern?(t?Object.assign(t,s):'global'===tt?I.upsertGlobalFunction(s):I.upsertLocalFunction(s),await rt(),await nt(),toastr.success(`函数"${s.name}"已${t?'更新':'创建'}`)):toastr.error('主动函数需要填写正则表达式'):toastr.error('请填写函数实现代码'):toastr.error('请填写函数名称')}async function rt(){try{if('global'===tt)t[Z]||(t[Z]={}),t[Z].functions=I.exportGlobalFunctions(),await i();else{const t=e();if(void 0===t.characterId)return void console.warn(K,'当前无角色，无法保存局域函数');const o=t.characters[t.characterId];if(!o)return void console.warn(K,'角色数据不存在');o.data.extensions||(o.data.extensions={}),o.data.extensions[Z]||(o.data.extensions[Z]={}),o.data.extensions[Z].functions=I.exportLocalFunctions(),await n(t.characterId,Z,o.data.extensions[Z])}console.log(K,`${tt} 函数已保存`)}catch(E){console.error(K,'保存函数失败:',E),toastr.error(`保存失败：${E.message}`)}}function at(t,e){return`@.${e}("path.to.var", value);`}function it(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,t=>{const e=16*Math.random()|0;return('x'===t?e:3&e|8).toString(16)})}const ct={AFFIRMATIVE:1},lt='[ST-VarSystemExtension/MessageSnapshots]';let dt=null;const ut={currentFloor:null,currentSwipeId:null,currentSnapshotId:null,draftBody:null,dirty:!1,hasErrors:!1};async function ft(){console.log(lt,'初始化楼层快照界面'),$('#var-system-floor-select').on('change',async t=>{const e=parseInt(t.target.value,10);Number.isNaN(e)||await pt(e)}),$('#var-system-jump-btn').on('click',async()=>{const t=parseInt($('#var-system-jump-input').val(),10);if(Number.isNaN(t))return void toastr.error('请输入有效的层号');const n=await async function(t){const n=e().chat;if(!n||t>=n.length)return!1;const o=n[t];if(o.is_user)return!1;const s=o.swipe_id||0,r=o.swipes_info?.[s]?.st_var_system_snapshot_id;return!!r}(t);n?$('#var-system-floor-select').val(t).trigger('change'):toastr.error(`第 ${t} 层没有绑定快照`)}),$('#var-system-refresh-snapshot-btn').on('click',async()=>{null!==ut.currentFloor&&(await pt(ut.currentFloor),toastr.info('已刷新快照'))}),$('#var-system-save-snapshot-btn').on('click',async()=>{await async function(){if(ut.hasErrors)toastr.error('快照数据有错误，无法保存');else if(ut.dirty)try{const t=dt.get(),e=await fetch(`/api/plugins/var-manager/var-manager/snapshots/${ut.currentSnapshotId}`,{method:'PUT',headers:{...s(),'Content-Type':'application/json'},body:JSON.stringify({snapshot:t})});if(!e.ok)throw new Error(`更新快照失败 (${e.status})`);ut.dirty=!1,$('#var-system-save-snapshot-btn').prop('disabled',!0),toastr.success('快照已保存')}catch(E){console.error(lt,'保存快照失败:',E),toastr.error(`保存失败：${E.message}`)}else toastr.info('快照未修改')}()}),$('#var-system-save-as-global-btn').on('click',async()=>{await async function(){const t=dt.get(),e=await l('请输入标签（用逗号分隔）：',d.INPUT,'',{rows:1});if(!e)return;const n=e.split(',').map(t=>t.trim()).filter(t=>t);try{const e=await fetch('/api/plugins/var-manager/var-manager/global-snapshots',{method:'POST',headers:{...s(),'Content-Type':'application/json'},body:JSON.stringify({snapshot:t,tags:n})});if(!e.ok)throw new Error(`保存失败 (${e.status})`);toastr.success('已保存为全局快照')}catch(E){console.error(lt,'保存全局快照失败:',E),toastr.error(`保存失败：${E.message}`)}}()}),$('#var-system-export-snapshot-btn').on('click',async()=>{await async function(){const t=dt.get(),e=JSON.stringify(t,null,2),n=new Blob([e],{type:'application/json'}),o=URL.createObjectURL(n),s=$('<a>');s.attr('href',o),s.attr('download',`snapshot-floor-${ut.currentFloor}-${Date.now()}.json`),s[0].click(),URL.revokeObjectURL(o),toastr.success('快照已导出')}()}),$('#var-system-import-snapshot-btn').on('click',async()=>{await async function(){const t=$('<input>');return t.attr('type','file'),t.attr('accept','.json'),new Promise(e=>{t.on('change',async t=>{const n=t.target.files?.[0];if(n)try{const t=await n.text(),o=JSON.parse(t);dt.set(o),ut.draftBody=o,ut.dirty=!0,$('#var-system-save-snapshot-btn').prop('disabled',!1),toastr.success('快照已导入（未保存）'),e()}catch(E){console.error(lt,'导入快照失败:',E),toastr.error(`导入失败：${E.message}`),e()}else e()}),t.click()})}()}),$('#var-system-strip-schema-btn').on('click',async()=>{await async function(){if(dt)try{const t=yt(dt.get());dt.set(t),ut.draftBody=t,ut.dirty=!0,$('#var-system-save-snapshot-btn').prop('disabled',!1),toastr.success('已移除 MVU Schema 字段')}catch(E){console.error(lt,'分离 Schema 失败:',E),toastr.error(`分离 Schema 失败：${E.message}`)}else toastr.error('编辑器尚未初始化')}()}),await async function(){const t=e().chat;if(!t||0===t.length)return void $('#var-system-floor-select').html('<option value="">当前无聊天记录</option>');const n=$('#var-system-floor-select');n.empty();let o=!1;for(let e=0;e<t.length;e++){const s=t[e];if(s.is_user)continue;const r=s.swipe_id||0,a=s.swipes_info?.[r]?.st_var_system_snapshot_id;if(a){o=!0;const t=$('<option>');t.val(e),t.text(`第 ${e} 层 - AI 消息 (Swipe ${r})`),n.append(t)}}o||n.html('<option value="">暂无快照楼层</option>')}()}async function pt(t){const n=e().chat;if(!n||t>=n.length)return void toastr.error('无效的楼层号');const o=n[t],r=o.swipe_id||0,a=o.swipes_info?.[r]?.st_var_system_snapshot_id;if(!a)return void toastr.error(`第 ${t} 层没有绑定快照`);const i=await async function(t){try{const e=await fetch(`/api/plugins/var-manager/var-manager/snapshots/${t}`,{method:'GET',headers:{...s(),'Content-Type':'application/json'}});if(!e.ok)return 404===e.status?console.warn(lt,`快照不存在: ${t}`):console.error(lt,`读取快照失败 (${e.status}): ${t}`),null;return(await e.json()).snapshot}catch(E){return console.error(lt,'从插件读取快照时发生错误:',E),null}}(a);if(!i)return void toastr.error('加载快照失败');ut.currentFloor=t,ut.currentSwipeId=r,ut.currentSnapshotId=a,ut.draftBody=i,ut.dirty=!1,ut.hasErrors=!1,$('#var-system-current-floor-info').show(),$('#current-floor-number').text(t),$('#current-swipe-id').text(r),$('#current-snapshot-id').text(a);const c=o.send_date?new Date(o.send_date).toLocaleString('zh-CN'):'未知';$('#current-message-time').text(c),await async function(t){const e=document.getElementById('var-system-snapshot-editor-container');$(e).find('.var-system-empty-state').remove(),dt&&(dt.destroy(),dt=null);dt=y({container:e,onChange:(t,e,n)=>{console.log('[MessageSnapshots] Editor change:',{hasContent:!!t,hasJson:void 0!==t?.json,jsonType:typeof t?.json,hasContentErrors:!!n?.contentErrors?.length,contentErrors:n?.contentErrors});const o=Boolean(n?.contentErrors?.length);ut.hasErrors=o,ut.dirty=!0,void 0!==t?.json&&(ut.draftBody=t.json),$('#var-system-save-snapshot-btn').prop('disabled',o)}}),await dt.ensureReady(),dt.set({json:t})}(i),$('#var-system-snapshot-actions').show(),$('#var-system-save-snapshot-btn').prop('disabled',!0)}function yt(t){if(Array.isArray(t))return t.filter(t=>'$__META_EXTENSIBLE__$'!==t).map(t=>yt(t));if(_.isObject(t)&&!_.isDate(t)){const e={};for(const n in t)n.startsWith('$')||(e[n]=yt(t[n]));return e}return t}const ht='[ST-VarSystemExtension/reprocessButton]';let mt=0;function gt(){console.log(ht,`初始化重新处理变量按钮 (尝试 ${mt+1}/10)`);if(0===$('.extraMesButtons').length)return mt++,void(mt<10?(console.warn(ht,`extraMesButtons 容器不存在，将在 1000ms 后重试 (${mt}/10)`),setTimeout(gt,1e3)):console.error(ht,'extraMesButtons 容器在 10 次重试后仍不存在，放弃初始化'));mt=0,0===$('#var-system-reprocess-btn').length?($('.extraMesButtons').append('\n    <div\n      id="var-system-reprocess-btn"\n      class="mes_button"\n      title="重新处理变量系统快照"\n      style="display: none;"\n    >\n      <i class="fa-solid fa-rotate"></i>\n      <span>重新处理变量</span>\n    </div>\n  '),console.log(ht,'重新处理变量按钮已添加到 DOM')):console.log(ht,'重新处理变量按钮已存在，跳过添加'),$(document).off('click','#var-system-reprocess-btn'),$(document).on('click','#var-system-reprocess-btn',vt),wt()}async function vt(){console.log(ht,'点击重新处理变量按钮');try{const t=e(),n=t.chat;if(!n||0===n.length)return void toastr.warning('当前聊天为空','变量系统');const o=t.characters[t.characterId];if(!(o?.data?.extensions?.st_var_system?.enabled??!1))return void toastr.warning('当前角色未启用变量系统','变量系统');let s=-1;for(let e=n.length-1;e>=0;e--)if(!n[e].is_user){s=e;break}if(-1===s)return void toastr.warning('没有找到 AI 消息','变量系统');const r=n[s],a=r.swipe_id||0,i=r.swipes_info?.[a]?.st_var_system_snapshot_id;i?(console.log(ht,`清除第 ${s} 层 (swipe ${a}) 的快照标识符:`,i),delete r.swipes_info[a].st_var_system_snapshot_id,await c()):console.log(ht,`第 ${s} 层 (swipe ${a}) 没有快照标识符，直接重新处理`),toastr.info('开始重新处理变量...','变量系统'),await J(s),toastr.success('变量重新处理完成','变量系统')}catch(E){console.error(ht,'重新处理变量失败:',E),toastr.error(`重新处理变量失败：${E.message}`,'变量系统')}}function wt(){try{const t=e(),n=t.characters?.[t.characterId],o=n?.data?.extensions?.st_var_system?.enabled??!1,s=t.chat&&t.chat.length>0;o&&s?$('#var-system-reprocess-btn').show():$('#var-system-reprocess-btn').hide()}catch(E){console.error(ht,'更新按钮显示状态失败:',E),$('#var-system-reprocess-btn').hide()}}const Et='[ST-VarSystemExtension/settings]';async function St(){console.log(Et,'开始清理未使用的快照');if(await callGenericPopup('此操作会删除数据库中不对应任何现存聊天记录的快照。\n\n已删除的快照无法恢复，确定要继续吗？',POPUP_TYPE.CONFIRM,'',{okButton:'确定',cancelButton:'取消'})===POPUP_RESULT.AFFIRMATIVE)try{$('#var-system-cleanup-snapshots-btn').prop('disabled',!0),$('#var-system-cleanup-progress').show(),$('#var-system-cleanup-result').hide(),_t(0,'正在扫描聊天记录文件...');const t=await async function(){try{const t=await fetch('/api/characters/chats',{method:'POST',headers:{'Content-Type':'application/json'}});if(!t.ok)throw new Error(`获取聊天记录失败: ${t.statusText}`);const e=await t.json();console.log(Et,'聊天记录数据:',e);const n=[];for(const o in e){const t=e[o];if(Array.isArray(t))for(const e of t){const t=e.replace(/\.jsonl$/,'');n.push(t)}}return n}catch(E){throw console.error(Et,'获取聊天记录文件失败:',E),new Error('无法获取聊天记录列表')}}();console.log(Et,`找到 ${t.length} 个聊天记录文件`),_t(50,`找到 ${t.length} 个聊天记录文件，正在清理...`);const e=await async function(t){try{const e=await fetch('/api/plugins/var-manager/var-manager/snapshots/cleanup',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-Token':await $t()},body:JSON.stringify({activeChatFiles:t})});if(404===e.status)throw new Error('插件未安装或未启用');if(!e.ok){const t=await e.text();throw new Error(`插件 API 错误: ${e.status} - ${t}`)}return await e.json()}catch(E){throw console.error(Et,'清理孤立快照失败:',E),E}}(t);_t(100,'清理完成'),setTimeout(()=>{$('#var-system-cleanup-progress').hide(),function(t){const{deletedCount:e,totalScanned:n,deletedChatFiles:o}=t;if($('#var-system-cleanup-result').show(),0===e)$('#var-system-cleanup-result-summary').html('<strong>未发现需要清理的快照</strong>'),$('#var-system-cleanup-result-details').text(`扫描了 ${n} 个快照，全部关联到现存的聊天记录。`);else{$('#var-system-cleanup-result-summary').html(`<strong>成功清理 ${e} 个孤立快照</strong>`);const t=`扫描了 ${n} 个快照，清理了 ${o.length} 个已删除聊天记录的快照。\n`+(o.length>0?`\n已清理的聊天文件：\n${o.slice(0,5).join('\n')}`+(o.length>5?`\n... 及其他 ${o.length-5} 个文件`:''):'');$('#var-system-cleanup-result-details').text(t)}toastr.success(`清理完成，删除了 ${e} 个孤立快照`,'变量系统')}(e)},500),console.log(Et,'清理完成',e)}catch(E){console.error(Et,'清理失败:',E),$('#var-system-cleanup-progress').hide(),toastr.error(`清理失败：${E.message}`,'变量系统')}finally{$('#var-system-cleanup-snapshots-btn').prop('disabled',!1)}}function _t(t,e){$('#var-system-cleanup-progress-fill').css('width',`${t}%`),$('#var-system-cleanup-progress-text').text(e)}async function $t(){if(window.token)return window.token;try{const t=await fetch('/csrf-token'),e=await t.json();return window.token=e.token,e.token}catch(E){return console.warn(Et,'获取 CSRF Token 失败，使用空字符串',E),''}}const bt='[ST-VarSystemExtension]',xt='st_var_system',Tt='var_system_template_status',Ct={editorController:null,currentCharacterId:null,templateBody:null,draftBody:null,enabled:!1,dirty:!1,hasErrors:!1,loading:!1},It='3.10.0',Bt=`https://cdn.jsdelivr.net/npm/vanilla-jsoneditor@${It}/themes/jse-theme-dark.css`,kt=`https://cdn.jsdelivr.net/npm/vanilla-jsoneditor@${It}/standalone.js`;let At=null,Ft=null;const jt={success:'#6ee7b7',error:'#fca5a5',warn:'#fbbf24',info:'var(--SmartThemeBodyColor, #aaa)'};function Lt(t){if(!t||At)return;At={save:t.querySelector('#var_system_template_save'),saveAsGlobal:t.querySelector('#var_system_template_save_as_global'),discard:t.querySelector('#var_system_template_discard'),reload:t.querySelector('#var_system_template_reload'),status:t.querySelector(`#${Tt}`),clear:t.querySelector('#var_system_template_clear'),enableToggle:t.querySelector('#var_system_template_enabled')},At.save?.addEventListener('click',()=>{!async function(){if(Ct.hasErrors)return void Ot('存在未解决的 JSON 错误，无法保存。','error');const t=await Pt();if(!t)return void Ot('编辑器尚未准备就绪。','error');const e=t.get(),o=e?.json;if(void 0===o)return void Ot('请修复模板中的错误后再保存。','error');const s=window.SillyTavern.getContext().characterId;if(null==s)return void Ot('未选择角色，无法保存模板。','error');Ct.loading=!0,Nt(),Ot('模板保存中……','info');try{const t={templateBody:o,enabled:Ct.enabled};await n(s,xt,t),Ct.templateBody=Vt(o),Ct.draftBody=Vt(o),Ct.dirty=!1,Ct.hasErrors=!1,Ot('模板已保存。','success')}catch(E){console.error(bt,'保存模板失败',E),Ot(`保存模板失败：${E?.message??E}`,'error')}finally{Ct.loading=!1,Nt()}}()}),At.saveAsGlobal?.addEventListener('click',()=>{!async function(){const t=window.SillyTavern.getContext();if(!t.characterId)return void(await l('请先选择一个角色',d.TEXT,'',{okButton:'确定'}));const e=await Pt();if(!e)return void Ot('编辑器尚未准备就绪。','error');const n=e.get(),o=n?.json;if(void 0===o||!o)return void(await l('当前模板为空或有错误，无法保存为全局快照',d.TEXT,'',{okButton:'确定'}));const s=t.characters?.[t.characterId],r=s?.name?`${s.name}的模板`:'角色模板',a=await l('请输入全局快照的名称：',d.INPUT,r,{okButton:'保存',cancelButton:'取消'});if(!a)return;try{Ot('正在保存为全局快照...','info');const t={name:a,description:`从角色"${s?.name||'未知'}"的模板创建`,tags:['角色模板',s?.name].filter(Boolean),snapshotBody:o};await ne('/global-snapshots',{method:'POST',body:JSON.stringify(t)}),Ot(`已保存为全局快照："${a}"`,'success'),console.log(`${bt} 角色模板已保存为全局快照:`,a);await l(`全局快照"${a}"已创建成功！\n\n是否切换到全局快照标签页查看？`,d.CONFIRM,'',{okButton:'查看',cancelButton:'留在这里'})&&(document.getElementById('var_system_tab_global')?.click(),await ae())}catch(E){console.error(`${bt} 保存为全局快照失败:`,E);let e='保存失败';e=E.message.includes('插件未安装')?'插件未安装或未启用。\n\n全局快照功能需要安装 ST-VarSystemPlugin 插件。':`保存失败: ${E.message}`,Ot(e,'error'),await l(e,d.TEXT,'',{okButton:'关闭'})}}()}),At.discard?.addEventListener('click',()=>{!async function(){if(!Ct.templateBody)return void Ot('没有可恢复的模板版本。','warn');Ct.draftBody=Vt(Ct.templateBody),Ct.dirty=!1,Ct.hasErrors=!1;const t=await Pt();t&&t.setValue(Ct.draftBody??{},{silent:!0});Nt(),Ot('已恢复为最后保存的模板。','info')}()}),At.reload?.addEventListener('click',()=>{Jt(!0)}),At.clear?.addEventListener('click',()=>{!async function(){const t=window.SillyTavern.getContext(),e=t.characterId;if(null==e)return void Ot('未选择角色，无法清空模板。','error');if(!Ct.templateBody)return void Ot('当前没有保存的模板，无需清空。','info');const o='确定要清空模板吗？这会从角色卡中移除模板字段，但不会改变启用状态。';if(!(window.confirm?.(o)??confirm(o)))return void Ot('已取消清空模板。','info');Ct.loading=!0,Nt(),Ot('正在清空模板……','info');try{const o={enabled:Ct.enabled};await n(e,xt,o);t.characters;const s=await Pt(),r={};Ct.templateBody=null,Ct.draftBody=Vt(r),Ct.dirty=!0,Ct.hasErrors=!1,s&&s.setValue(r,{silent:!1}),Ot('模板字段已清空，编辑器已恢复默认骨架，请视需要重新保存。','warn')}catch(E){console.error(bt,'清空模板失败',E),Ot(`清空模板失败：${E?.message??E}`,'error')}finally{Ct.loading=!1,Nt()}}()}),At.enableToggle?.addEventListener('change',t=>{!async function(t){const e=window.SillyTavern.getContext().characterId;if(null==e)return Ot('未选择角色，无法修改启用状态。','error'),void Dt();if(Ct.loading)return void Dt();const o=Ct.enabled;Ct.enabled=Boolean(t),Ct.loading=!0,Nt(),Ot(Ct.enabled?'正在启用变量系统……':'正在停用变量系统……','info');try{const t={enabled:Ct.enabled};Ct.templateBody&&(t.templateBody=Vt(Ct.templateBody)),await n(e,xt,t),Ot(Ct.enabled?'变量系统已为该角色启用。':'变量系统已为该角色停用。','success')}catch(E){console.error(bt,'更新启用状态失败',E),Ct.enabled=o,Ot(`更新启用状态失败：${E?.message??E}`,'error')}finally{Ct.loading=!1,Dt(),Nt()}}(Boolean(t.target?.checked))});const e=t.querySelector('#var_system_template_export'),o=t.querySelector('#var_system_template_import'),s=t.querySelector('#var_system_template_strip_schema');e?.addEventListener('click',()=>{!async function(){const t=await Pt();if(!t)return void toastr.error('编辑器尚未准备就绪');const e=t.get(),n=e?.json;if(void 0===n)return void toastr.error('请修复模板中的错误后再导出');const o=window.SillyTavern.getContext(),s=o.characters?.[o.characterId],r=s?.name||'unknown',a=(new Date).toISOString().replace(/[:.]/g,'-').slice(0,19),i=`template_${r}_${a}.json`;Zt(n,i),toastr.success(`已导出：${i}`)}()}),o?.addEventListener('click',()=>{!async function(){const t=await te();if(!t)return;const e=await Pt();if(!e)return void toastr.error('编辑器尚未准备就绪');const n=ee(t,!1);e.set({json:n}),Ct.dirty=!0,Ct.draftBody=Vt(n),Nt(),toastr.success('JSON 已导入到编辑器')}()}),s?.addEventListener('click',()=>{!async function(){const t=await Pt();if(!t)return void toastr.error('编辑器尚未准备就绪');const e=t.get(),n=e?.json;if(void 0===n)return void toastr.error('请修复模板中的错误后再分离 Schema');const o=Kt(n);t.set({json:o}),Ct.dirty=!0,Ct.draftBody=Vt(o),Nt(),toastr.success('已移除 MVU Schema 字段')}()}),Ot('尚未加载模板','info'),Nt()}function Ot(t,e='info'){const n=At?.status||document.getElementById(Tt);n&&(n.textContent=t??'',n.style.color=jt[e]??jt.info)}function Nt(){if(!At)return;const t=null!==Ct.templateBody,e=Ct.loading||!Ct.draftBody;At.save&&(At.save.disabled=e||Ct.hasErrors||!Ct.dirty),At.discard&&(At.discard.disabled=e||!t||!Ct.dirty),At.reload&&(At.reload.disabled=Ct.loading),At.clear&&(At.clear.disabled=Ct.loading||!t),Dt()}function Dt(){if(!At?.enableToggle)return;const t=Ct.loading||!Ct.currentCharacterId;At.enableToggle.disabled=t,At.enableToggle.checked=Boolean(Ct.enabled)}function Mt(t=!1){null!==Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{Ft=null,Jt(t)},0)}function Vt(t){return null==t?t:'function'==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t))}async function Pt({readOnly:t=!1}={}){const e=document.getElementById('var_system_template_editor');if(!e)return null;Ct.editorController?Ct.editorController.setContainer(e):Ct.editorController=y({container:e,initialValue:Ct.draftBody??{},styleUrl:Bt,scriptUrl:kt,readOnly:t,onChange:Rt,onFallback:()=>{Ot('JSON 编辑器资源加载失败，已降级为纯文本模式。','warn'),Nt()}});try{await Ct.editorController.ensureReady()}catch(E){return console.error(bt,'初始化编辑器失败',E),null}return Ct.editorController}function Rt(t,e,n){console.log('[ST-VarSystemExtension] handleEditorChange:',{hasContent:!!t,hasJson:void 0!==t?.json,jsonType:typeof t?.json,hasContentErrors:!!n?.contentErrors?.length,contentErrors:n?.contentErrors});const o=Boolean(n?.contentErrors?.length);Ct.hasErrors=o,Ct.dirty=!0,void 0!==t?.json&&(Ct.draftBody=Vt(t.json)),Nt(),Ot(o?'JSON 无法解析，请检查错误。':'模板已修改，尚未保存。',o?'error':'warn')}async function Jt(t=!1){const e=window.SillyTavern.getContext(),n=e.characterId;if(null==n)return Ct.currentCharacterId=null,Ct.templateBody=null,Ct.draftBody=null,Ct.enabled=!1,Ct.dirty=!1,Ct.hasErrors=!1,Ct.loading=!1,Ct.editorController&&Ct.editorController.setValue({},{silent:!0}),Ot('请选择角色后再编辑模板。','warn'),void Nt();if(t||Ct.currentCharacterId!==n){Ct.loading=!0,Nt(),Ot('模板加载中……','info');try{const t=await Pt(),o=e.characters?.[n],s=o?.data?.extensions?.[xt]??null,r=Boolean(s?.templateBody),a=r?s.templateBody:{};Ct.currentCharacterId=n,Ct.templateBody=r?Vt(a):null,Ct.draftBody=Vt(a),Ct.enabled=Boolean(s?.enabled),Ct.dirty=!r,Ct.hasErrors=!1,t&&t.setValue(Ct.draftBody??{},{silent:!0});Ot(r?'模板已加载。':'已为该角色准备默认模板，请完善后保存。',r?'info':'warn')}catch(E){console.error(bt,'加载模板失败',E),Ot(`加载模板失败：${E?.message??E}`,'error')}finally{Ct.loading=!1,Nt()}}}function Ht(){Mt(!0)}function Gt(t,e){const n=window.EDITOR;if(n?.slideToggle){const e={...n.getSlideToggleOptions?.()??{},onAnimationEnd:t=>{t.closest('.drawer-content')?.classList.remove('resizing')}};return t.classList.add('resizing'),void n.slideToggle(t,e)}const o=$(t);e?o.stop(!0,!0).slideDown(200):o.stop(!0,!0).slideUp(200)}function Ut(t,e){t.hasClass('openIcon')&&(t.toggleClass('openIcon closedIcon'),e.toggleClass('openDrawer closedDrawer'),Gt(e.get(0),!1))}let qt='character';function zt(t){qt!==t&&(qt=t,document.querySelectorAll('.var-system-tab').forEach(e=>{e.dataset.tab===t?(e.classList.add('active'),e.style.borderBottomColor='var(--SmartThemeQuoteColor, #4a9eff)',e.style.color='var(--SmartThemeQuoteColor, #4a9eff)'):(e.classList.remove('active'),e.style.borderBottomColor='transparent',e.style.color='var(--SmartThemeBodyColor, inherit)')}),document.querySelectorAll('.var-system-tab-content').forEach(e=>{e.dataset.tab===t?e.style.display='flex':e.style.display='none'}),console.log(`${bt} 切换到标签页: ${t}`),'global'===t?ae():'functions'===t?console.log(`${bt} 函数库标签页已激活`):'messages'===t&&console.log(`${bt} 楼层快照标签页已激活`))}const Xt='/api/plugins/var-manager/var-manager',Wt={snapshots:[],filteredSnapshots:[],searchQuery:'',selectedTag:'',loading:!1,viewMode:'list',editorController:null,editingSnapshotId:null,draftSnapshot:null};let Qt=null,Yt=null;function Kt(t){if(Array.isArray(t))return t.filter(t=>'$__META_EXTENSIBLE__$'!==t).map(t=>Kt(t));if('object'==typeof t&&null!==t&&!(t instanceof Date)){const e={};for(const n in t)n.startsWith('$')||(e[n]=Kt(t[n]));return e}return t}function Zt(t,e){const n=JSON.stringify(t,null,2),o=new Blob([n],{type:'application/json'}),s=URL.createObjectURL(o),r=document.createElement('a');r.href=s,r.download=e,r.click(),URL.revokeObjectURL(s)}async function te(){return new Promise(t=>{const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const n=e.target.files?.[0];if(n)try{const e=await n.text(),o=JSON.parse(e);t(o)}catch(E){toastr.error(`导入失败：${E.message}`),t(null)}else t(null)},e.click()})}function ee(t,e=!1){if(!t||'object'!=typeof t)return{};if('metadata'in t&&'variables'in t){console.log(`${bt} 检测到旧格式快照，自动提取 variables 字段`);const n=t.variables||{};return e&&'object'==typeof n?Kt(n):n}return e&&'object'==typeof t?Kt(t):t}async function ne(t,e={}){const n=`${Xt}${t}`,o={...s(),'Content-Type':'application/json',...e.headers};try{const t=await fetch(n,{...e,headers:o});if(!t.ok){if(404===t.status)throw new Error('插件未安装或未启用');throw new Error(`API 请求失败: ${t.status} ${t.statusText}`)}return 204===t.status?null:await t.json()}catch(E){throw console.error(`${bt} API 调用失败:`,t,E),E}}function oe(t){if(Wt.viewMode===t)return;Wt.viewMode=t;const e=document.getElementById('var_system_snapshots_list_view'),n=document.getElementById('var_system_snapshot_editor_view');'list'===t?(e.style.display='flex',n.style.display='none'):(e.style.display='none',n.style.display='flex'),console.log(`${bt} 快照视图切换到: ${t}`)}async function se(){if(Wt.editorController)return;const t=document.getElementById('var_system_snapshot_body_editor');if(t)try{Wt.editorController=y({container:t,initialValue:{},styleUrl:Bt,scriptUrl:kt,readOnly:!1,onChange:()=>{re('已修改，未保存','warn')},onFallback:()=>{console.warn(`${bt} 快照编辑器 JSON 资源加载失败，已降级为纯文本模式`),re('编辑器已降级为纯文本模式','warn')}}),await Wt.editorController.ensureReady(),console.log(`${bt} 快照编辑器已初始化`)}catch(E){console.error(`${bt} 快照编辑器初始化失败:`,E)}else console.error(`${bt} 找不到快照编辑器容器`)}function re(t,e='info'){const n=document.getElementById('var_system_snapshot_editor_status');n&&(n.textContent=t,n.style.color=jt[e]||jt.info)}async function ae(){if(Wt.loading)console.log(`${bt} 快照正在加载中，跳过重复请求`);else{Wt.loading=!0,le('加载中...');try{console.log(`${bt} 开始加载全局快照...`);const t=await ne('/global-snapshots');Wt.snapshots=t.snapshots||[],console.log(`${bt} 已加载 ${Wt.snapshots.length} 个全局快照`,Wt.snapshots),ie(),ce(),function(){const t=document.getElementById('var_system_snapshot_tag_filter');if(!t)return;const e=new Set;Wt.snapshots.forEach(t=>{t.tags&&Array.isArray(t.tags)&&t.tags.forEach(t=>{t?.trim()&&e.add(t.trim())})});const n=Array.from(e).sort(),o=t.value;t.innerHTML='<option value="" data-i18n="All tags">所有标签</option>',n.forEach(e=>{const n=document.createElement('option');n.value=e,n.textContent=e,t.appendChild(n)}),o&&n.includes(o)&&(t.value=o)}()}catch(E){console.error(`${bt} 加载全局快照失败:`,E),Wt.snapshots=[],Wt.filteredSnapshots=[];let e='加载失败';e=E.message.includes('插件未安装')?'插件未安装或未启用<br><br>全局快照功能需要安装 ST-VarSystemPlugin 插件':E.message.includes('Failed to fetch')?'无法连接到插件 API<br><br>请确保 SillyTavern 服务器正在运行':`加载失败: ${E.message}`,le(e),ce()}finally{Wt.loading=!1,console.log(`${bt} 加载全局快照完成，loading = false`)}}}function ie(){let t=[...Wt.snapshots];if(Wt.searchQuery){const e=Wt.searchQuery.toLowerCase();t=t.filter(t=>t.name.toLowerCase().includes(e)||t.description?.toLowerCase().includes(e))}Wt.selectedTag&&(t=t.filter(t=>t.tags?.includes(Wt.selectedTag))),Wt.filteredSnapshots=t}function ce(){const t=document.getElementById('var_system_snapshots_list'),e=document.getElementById('var_system_snapshots_empty');if(t){if(t.querySelectorAll('.snapshot-card').forEach(t=>{t.remove()}),0===Wt.filteredSnapshots.length)return e.innerHTML='\n      <i class="fa-solid fa-inbox fa-3x" style="margin-bottom: 10px; opacity: 0.5"></i>\n      <p data-i18n="No snapshots yet">暂无全局快照</p>\n      <p style="font-size: 12px" data-i18n="Click New to create one">点击"新建快照"创建第一个快照</p>\n    ',void(e.style.display='block');e.style.display='none',Wt.filteredSnapshots.forEach(n=>{const o=function(t){const e=document.createElement('div');e.className='snapshot-card',e.dataset.snapshotId=t.snapshotId,e.style.cssText='\n    border: 1px solid var(--SmartThemeBorderColor, #333);\n    border-radius: 6px;\n    padding: 14px;\n    background: var(--SmartThemeBlurTintColor, rgba(0,0,0,0.2));\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    transition: border-color 0.2s, box-shadow 0.2s;\n  ',e.addEventListener('mouseenter',()=>{e.style.borderColor='var(--SmartThemeQuoteColor, #4a9eff)',e.style.boxShadow='0 2px 8px rgba(74, 158, 255, 0.2)'}),e.addEventListener('mouseleave',()=>{e.style.borderColor='var(--SmartThemeBorderColor, #333)',e.style.boxShadow='none'});const n=document.createElement('h4');if(n.textContent=t.name,n.style.cssText='margin: 0; font-size: 16px; font-weight: 600;',e.appendChild(n),t.description){const n=document.createElement('p');n.textContent=t.description,n.style.cssText='margin: 0; font-size: 13px; color: var(--SmartThemeBodyColor, #aaa); line-height: 1.4;',e.appendChild(n)}if(t.tags&&t.tags.length>0){const n=document.createElement('div');n.style.cssText='display: flex; gap: 6px; flex-wrap: wrap;',t.tags.forEach(t=>{const e=document.createElement('span');e.textContent=t,e.style.cssText='\n        padding: 3px 10px;\n        font-size: 11px;\n        border-radius: 12px;\n        background: var(--SmartThemeQuoteColor, #4a9eff);\n        color: white;\n        font-weight: 500;\n        letter-spacing: 0.3px;\n      ',n.appendChild(e)}),e.appendChild(n)}const o=document.createElement('div');o.style.cssText='font-size: 11px; color: var(--SmartThemeBodyColor, #888);';const s=new Date(t.createdAt).toLocaleString('zh-CN');o.textContent=`创建于 ${s}`,e.appendChild(o);const r=document.createElement('div');r.style.cssText='display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px;';const a=[{text:'查看/编辑',icon:'fa-pen-to-square',action:()=>async function(t){console.log(`${bt} 编辑快照:`,t);try{const e=await ne(`/global-snapshots/${t}`);Wt.editingSnapshotId=t,Wt.draftSnapshot={...e},oe('editor');const n=document.getElementById('var_system_snapshot_editor_title');n&&(n.textContent=`编辑快照: ${e.name}`),document.getElementById('var_system_snapshot_name').value=e.name||'',document.getElementById('var_system_snapshot_description').value=e.description||'',document.getElementById('var_system_snapshot_tags').value=e.tags?e.tags.join(', '):'',await se();const o=ee(e.snapshotBody);Wt.editorController?Wt.editorController.set({json:o}):console.error(`${bt} 编辑器未能初始化`),re('编辑快照，修改后点击保存','info')}catch(E){console.error(`${bt} 加载快照失败:`,E),await l(`加载快照失败: ${E.message}`,d.TEXT,'',{okButton:'关闭'})}}(t.snapshotId)},{text:'应用到角色',icon:'fa-download',action:()=>async function(t){if(!window.SillyTavern.getContext().characterId)return void(await l('请先选择一个角色',d.TEXT,'',{okButton:'确定'}));try{const e=await ne(`/global-snapshots/${t}`);if(!(await l(`将快照 "${e.name}" 应用到当前角色会覆盖现有模板内容。\n\n是否继续？`,d.CONFIRM,'',{okButton:'应用',cancelButton:'取消'})))return;const n=ee(e.snapshotBody);Ct.draftBody=n,Ct.dirty=!0,Ct.editorController&&Ct.editorController.set({json:Ct.draftBody}),Ot(`已加载快照 "${e.name}"，请保存以应用`,'success'),Nt(),zt('character'),console.log(`${bt} 已将快照 ${t} 加载到角色模板`)}catch(E){console.error(`${bt} 加载快照失败:`,E),await l(`加载快照失败: ${E.message}`,d.TEXT,'',{okButton:'关闭'})}}(t.snapshotId)},{text:'删除',icon:'fa-trash',action:()=>async function(t){const e=Wt.snapshots.find(e=>e.snapshotId===t);if(!e)return;const n=await l(`确定要删除快照 "${e.name}" 吗？\n\n此操作不可撤销。`,d.CONFIRM,'',{okButton:'删除',cancelButton:'取消'});if(!n)return;try{await ne(`/global-snapshots/${t}`,{method:'DELETE'}),console.log(`${bt} 已删除快照:`,t),Wt.snapshots=Wt.snapshots.filter(e=>e.snapshotId!==t),ie(),ce()}catch(E){console.error(`${bt} 删除快照失败:`,E),await l(`删除失败: ${E.message}`,d.TEXT,'',{okButton:'关闭'})}}(t.snapshotId),danger:!0}];return a.forEach(t=>{const e=document.createElement('button');e.className='menu_button interactable';const n=t.danger?'color: #ff6b6b;':'';e.style.cssText=`padding: 4px 10px; font-size: 12px; white-space: nowrap; ${n}`,e.innerHTML=`<i class="fa-solid ${t.icon} fa-fw"></i> <span>${t.text}</span>`,e.addEventListener('click',t.action),r.appendChild(e)}),e.appendChild(r),e}(n);t.insertBefore(o,e)})}}function le(t){const e=document.getElementById('var_system_snapshots_empty');e&&(e.innerHTML=`<p style="text-align: center; padding: 20px;">${t}</p>`,e.style.display='block')}async function de(){const t=document.getElementById('var_system_snapshot_name').value.trim()!==(Wt.draftSnapshot?.name||''),e=document.getElementById('var_system_snapshot_description').value.trim()!==(Wt.draftSnapshot?.description||'');if(t||e){if(!(await l('有未保存的修改，确定要放弃吗？',d.CONFIRM,'',{okButton:'放弃',cancelButton:'继续编辑'})))return}Wt.editingSnapshotId=null,Wt.draftSnapshot=null,oe('list'),ce()}function ue(t){t&&!Qt&&(Qt={search:t.querySelector('#var_system_snapshot_search'),tagFilter:t.querySelector('#var_system_snapshot_tag_filter'),newBtn:t.querySelector('#var_system_snapshot_new'),refreshBtn:t.querySelector('#var_system_snapshot_refresh')},Yt={back:t.querySelector('#var_system_snapshot_editor_back'),save:t.querySelector('#var_system_snapshot_editor_save'),cancel:t.querySelector('#var_system_snapshot_editor_cancel'),export:t.querySelector('#var_system_snapshot_editor_export'),import:t.querySelector('#var_system_snapshot_editor_import'),stripSchema:t.querySelector('#var_system_snapshot_editor_strip_schema')},Qt.search?.addEventListener('input',t=>{Wt.searchQuery=t.target.value,ie(),ce()}),Qt.tagFilter?.addEventListener('change',t=>{Wt.selectedTag=t.target.value,ie(),ce()}),Qt.newBtn?.addEventListener('click',()=>{!async function(){console.log(`${bt} 新建快照`),Wt.editingSnapshotId=null,Wt.draftSnapshot={name:'',description:'',tags:[],snapshotBody:{}},oe('editor');const t=document.getElementById('var_system_snapshot_editor_title');t&&(t.textContent='新建快照'),document.getElementById('var_system_snapshot_name').value='',document.getElementById('var_system_snapshot_description').value='',document.getElementById('var_system_snapshot_tags').value='',await se(),Wt.editorController?Wt.editorController.set({json:Wt.draftSnapshot.snapshotBody}):console.error(`${bt} 编辑器未能初始化`),re('新建快照，填写信息后点击保存','info')}()}),Qt.refreshBtn?.addEventListener('click',()=>{ae()}),Yt.back?.addEventListener('click',()=>{de()}),Yt.save?.addEventListener('click',()=>{!async function(){try{const t=document.getElementById('var_system_snapshot_name').value.trim(),e=document.getElementById('var_system_snapshot_description').value.trim(),n=document.getElementById('var_system_snapshot_tags').value.trim();if(!t)return void(await l('请输入快照名称',d.TEXT,'',{okButton:'确定'}));let o=null;if(Wt.editorController)try{o=Wt.editorController.get().json}catch(E){return console.error(`${bt} 获取编辑器内容失败:`,E),void(await l('编辑器内容有误，请检查 JSON 格式',d.TEXT,'',{okButton:'确定'}))}const s=n?n.split(',').map(t=>t.trim()).filter(t=>t):[],r={snapshotId:Wt.editingSnapshotId||void 0,name:t,description:e,tags:s,snapshotBody:o};re('保存中...','info'),await ne('/global-snapshots',{method:'POST',body:JSON.stringify(r)}),console.log(`${bt} 快照已保存:`,Wt.editingSnapshotId||'new'),oe('list'),await ae()}catch(E){console.error(`${bt} 保存快照失败:`,E),re(`保存失败: ${E.message}`,'error'),await l(`保存失败: ${E.message}`,d.TEXT,'',{okButton:'关闭'})}}()}),Yt.cancel?.addEventListener('click',()=>{de()}),Yt.export?.addEventListener('click',()=>{!async function(){if(Wt.editorController)try{const t=Wt.editorController.get(),e=t?.json;if(void 0===e)return void toastr.error('请修复 JSON 错误后再导出');const n=`global_snapshot_${document.getElementById('var_system_snapshot_name')?.value.trim()||'snapshot'}_${(new Date).toISOString().replace(/[:.]/g,'-').slice(0,19)}.json`;Zt(e,n),toastr.success(`已导出：${n}`)}catch(E){console.error(`${bt} 导出快照失败:`,E),toastr.error(`导出失败：${E.message}`)}else toastr.error('编辑器尚未准备就绪')}()}),Yt.import?.addEventListener('click',()=>{!async function(){const t=await te();if(t)if(Wt.editorController)try{const e=ee(t,!1);Wt.editorController.set({json:e}),toastr.success('JSON 已导入到编辑器')}catch(E){console.error(`${bt} 导入快照失败:`,E),toastr.error(`导入失败：${E.message}`)}else toastr.error('编辑器尚未准备就绪')}()}),Yt.stripSchema?.addEventListener('click',()=>{!async function(){if(Wt.editorController)try{const t=Wt.editorController.get(),e=t?.json;if(void 0===e)return void toastr.error('请修复 JSON 错误后再分离 Schema');const n=Kt(e);Wt.editorController.set({json:n}),toastr.success('已移除 MVU Schema 字段')}catch(E){console.error(`${bt} 分离 Schema 失败:`,E),toastr.error(`分离 Schema 失败：${E.message}`)}else toastr.error('编辑器尚未准备就绪')}()}))}async function fe(t){if(!t)return;const e=t.querySelector('#var_system_settings_section');if(e)try{const t=await fetch('/scripts/extensions/third-party/ST-VarSystemExtension/src/ui/settings.html').then(t=>t.text());e.innerHTML=t,await async function(){console.log(Et,'初始化设置标签页'),$('#var-system-cleanup-snapshots-btn').on('click',St)}(),console.log(`${bt} 设置标签页已加载`)}catch(E){console.error(`${bt} 加载设置失败:`,E)}else console.warn(`${bt} 找不到设置容器`)}async function pe(){if(document.querySelector('#var_system_drawer'))return;let t=null;try{t=await o('third-party/ST-VarSystemExtension/assets/templates','appHeaderVarSystemDrawer')}catch(E){return void console.warn(`${bt} 模板 appHeaderVarSystemDrawer 加载失败`,E)}if(!t)return void console.warn(`${bt} 模板 appHeaderVarSystemDrawer 返回空内容`);const e=$(t),n=$('#extensions-settings-button');if(0===n.length)return void console.warn(`${bt} 找不到扩展设置按钮，无法插入入口`);n.after(e);const s=e.find('#var_system_drawer_icon'),r=e.find('#var_system_drawer_content');r.hide(),e.find('.drawer-toggle').on('click',()=>{s.hasClass('openIcon')?Ut(s,r):function(t,e){t.hasClass('openIcon')||($('.drawer-icon.openIcon').not(t).each((_,t)=>{const e=$(t),n=e.closest('.drawer').find('.drawer-content').first();Ut(e,n)}),t.toggleClass('closedIcon openIcon'),e.toggleClass('closedDrawer openDrawer'),Gt(e.get(0),!0))}(s,r)});const a=e.get(0);Lt(a),function(t){t.querySelectorAll('.var-system-tab').forEach(t=>{t.addEventListener('click',()=>{zt(t.dataset.tab)})})}(a),ue(a),await async function(t){if(!t)return;const e=t.querySelector('#var_system_functions_section');if(e)try{const t=await fetch('/scripts/extensions/third-party/ST-VarSystemExtension/src/ui/functionLibrary.html').then(t=>t.text());e.innerHTML=t;const n=document.createElement('link');n.rel='stylesheet',n.href='/scripts/extensions/third-party/ST-VarSystemExtension/src/ui/phase4.css',document.head.appendChild(n),await et(),console.log(`${bt} 函数库标签页已加载`)}catch(E){console.error(`${bt} 加载函数库失败:`,E)}else console.warn(`${bt} 找不到函数库容器`)}(a),await async function(t){if(!t)return;const e=t.querySelector('#var_system_messages_section');if(e)try{const t=await fetch('/scripts/extensions/third-party/ST-VarSystemExtension/src/ui/messageSnapshots.html').then(t=>t.text());e.innerHTML=t,await ft(),console.log(`${bt} 楼层快照标签页已加载`)}catch(E){console.error(`${bt} 加载楼层快照失败:`,E)}else console.warn(`${bt} 找不到楼层快照容器`)}(a),await fe(a),Mt(!0),console.log(`${bt} 自定义入口已注入`)}async function ye(){console.log(`${bt} (st-var-system) 初始化`),await pe(),r.on(a.CHAT_CHANGED,Ht),r.on(a.CHARACTER_EDITOR_OPENED,Ht),console.log(H,'注册事件监听器'),r.on(a.MESSAGE_RECEIVED,q),r.on(a.MESSAGE_SWIPED,X),r.on(a.CHAT_CHANGED,W),r.on(a.MESSAGE_DELETED,Q),r.on(a.CHAT_DELETED,Y),console.log(H,'事件监听器已注册'),console.log(`${bt} 事件监听器已注册`),gt(),console.log(`${bt} 重新处理变量按钮已初始化`),r.on(a.CHAT_CHANGED,wt),r.on(a.MESSAGE_RECEIVED,wt),r.on(a.CHARACTER_EDITOR_OPENED,wt)}window.STVarSystemExtension={init:ye,exit:async function(){console.log(`${bt} 卸载`),r.removeListener(a.CHAT_CHANGED,Ht),r.removeListener(a.CHARACTER_EDITOR_OPENED,Ht),r.removeListener(a.CHAT_CHANGED,wt),r.removeListener(a.MESSAGE_RECEIVED,wt),r.removeListener(a.CHARACTER_EDITOR_OPENED,wt),console.log(H,'卸载事件监听器'),r.removeListener(a.MESSAGE_RECEIVED,q),r.removeListener(a.MESSAGE_SWIPED,X),r.removeListener(a.CHAT_CHANGED,W),r.removeListener(a.MESSAGE_DELETED,Q),r.removeListener(a.CHAT_DELETED,Y),console.log(H,'事件监听器已卸载'),console.log(`${bt} 事件监听器已卸载`)}},$(async()=>{try{await ye()}catch(E){console.error(`${bt} 初始化失败`,E)}});
//# sourceMappingURL=index.js.map
