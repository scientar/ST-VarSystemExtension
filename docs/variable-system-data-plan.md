# 变量系统数据结构与交互方案

## 1. 背景与目标

- **目标一致性**：确保前端扩展与后端插件能够完整表达并操作 MVU、SAM 及记忆增强扩展中约定的变量结构与元信息。
- **模板兼容性**：模板应支持 `$meta` 元数据、基本类型、对象、数组及特殊占位符（如 `$__META_EXTENSIBLE__$`）。
- **编辑体验**：提供直观的可视化编辑界面，并保留 JSON 原始编辑能力，实现“美观 + 高效 + 可降级”。
- **扩展性**：设计统一的模型层，为后续引入快照、历史版本及校验规则预留接口。

## 2. 数据结构建模

### 2.1 类型覆盖范围

| 类型                         | 描述                    | MVU/SAM 对应写法                | 处理策略                                  |
| ---------------------------- | ----------------------- | ------------------------------- | ----------------------------------------- |
| `string/number/boolean/null` | 基本值                  | `"未召唤"`, `1`, `true`, `null` | 原样存储，记录类型信息以便校验与 UI 展示  |
| 对象 (`{}`)                  | 包含字段的复合结构      | `{"简介": ""}`                  | 解析字段，支持 `$meta` 描述扩展性、必填项 |
| 数组 (`[]`)                  | 有序集合                | `[]`, `[1,2]`                   | 区分“值数组”与“描述元组”（见 2.2）        |
| 特殊标记                     | `$__META_EXTENSIBLE__$` | 数组首元素                      | 解析为“可扩展数组”标识                    |

### 2.2 元组数组与说明文本

- MVU 模板使用 `[value, description]` 结构存储字段值与说明文字。
- 方案：在解析层将其映射为 `{ value, note, noteFormat }`，默认 `noteFormat` 为 `plain`，未来可扩展 `markdown`。
- 对于数组第一个元素为 `$__META_EXTENSIBLE__$` 的情况，视为“值列表且可扩展”，保留原始顺序。

### 2.3 `$meta` 约定

参考 MVU 文档中对 `$meta` 的定义（`extensible`、`required`、`recursiveExtensible`、`template`），扩展系统内的语义如下：

| 字段                  | 含义                                     | 默认值   | UI 功能/处理策略                                               |
| --------------------- | ---------------------------------------- | -------- | -------------------------------------------------------------- |
| `extensible`          | 当前对象/数组是否允许增删子项            | `false`  | 控制“新增/删除”按钮；为 `true` 时默认所有子项 `required=false` |
| `required`            | 必填子键列表                             | `[]`     | 树视图高亮；在校验阶段阻止删除                                 |
| `recursiveExtensible` | 是否向下递归继承 `extensible=true` 行为  | `false`  | 调整子节点默认交互，同步渲染继承标识                           |
| `template`            | 新增子结构时合并的默认骨架（对象或数组） | `null`   | 在 UI 中提供“按模板新增”入口，自动补全字段                     |
| `type`（新增）        | 解析器推导或用户指定的期望类型           | 自动推断 | 作为二次校验、表单控件选择依据                                 |
| `validators`（预留）  | 自定义校验器定义数组                     | `[]`     | 未来支持脚本化校验时调用                                       |

> 注：兼容 MVU 行为，`$meta` 会在模板实际注入变量系统后自动剥离，仅在编辑器/解析器阶段存在。UI 需允许用户查看但明确提示“不会写回 stat_data”。

### 2.4 数组扩展标记 `$__META_EXTENSIBLE__$`

- 解析时识别数组内任意位置出现的 `$__META_EXTENSIBLE__$`，将其转换为 `meta.extensible=true` 并在序列化前移除该占位字符串。
- 默认数组为不可扩展；若标记存在则允许添加新元素，并可结合 `meta.template` 指定数组元素结构。
- 后续快照视图复用该语义，以区分“固定表格”与“动态列表”。

### 2.5 模型层设计

- 解析器：输入模板 JSON，生成 `TemplateNode` 树，节点包含 `id`, `key`, `type`, `meta`, `value`, `note`。
- 校验器：依据 `meta.required`、`meta.extensible`、`type` 进行静态检查，给出提示。
- 序列化：将编辑后的节点树回写成原始 JSON，确保与 MVU/SAM 兼容。

## 3. 前端交互设计

### 3.1 布局

1. **工具栏**：位于顶部，包含启用开关、保存、清空、校验、加载服务器按钮；显示当前模板状态与最近保存时间。
2. **侧边树视图**：
   - 树节点展示键名与当前值摘要。
   - 必填字段以标识显示。
   - 可扩展节点提供“新增字段/元素”按钮。
3. **详情编辑区**：
   - 切换式面板：`可视化表单` / `JSON 原始编辑`。
   - 表单模式根据节点类型渲染对应控件（文本框、数字输入、数组表格、键值列表）。
   - 描述文本支持 Markdown 预览（预留）。
4. **元信息面板**：在详情区侧边显示/编辑 `extensible` 等字段，灰显不可编辑项。

### 3.2 交互流程

- **节点选择**：点击树节点后，右侧加载对应表单，支持即时预览与撤销。
- **新增/删除**：依据 `extensible` 控制按钮状态；删除需确认弹窗，保留撤销能力。
- **校验提示**：保存前自动运行校验器；错误在树节点与详情顶部同步显示。
- **降级策略**：
  - JSON 编辑模式始终可用。
  - 若 `vanilla-jsoneditor` 加载失败，展示只读警告并退回纯文本编辑。

### 3.3 大体量内容呈现策略

- **虚拟滚动与分段加载**：树节点对应的数据表格/数组超过阈值时启用虚拟列表，避免一次渲染数万字符造成卡顿。
- **分栏对照视图**：为嵌套数组（如记忆增强的“多列表格”）提供“表格视图/原始 JSON”双栏切换，表格视图支持按列折叠、固定列头与快速跳转。
- **全文搜索与跳转**：提供关键字检索栏，可在长数组内高亮并跳转到对应行，同时同步树节点展开状态。
- **侧边摘要预览**：抽屉右侧预留“摘要侧栏”，显示子项的前若干字符及统计信息（行数、字数），便于识别超长内容。
- **快照复用**：上述呈现组件将与未来的快照浏览共用，实现模板与历史数据的统一体验。

## 4. 后端与存储

- 模板保存策略保持现有接口：前端写入角色卡 `st_var_system`，并尝试同步服务器 `/api/plugins/var-manager/var-manager/templates`。
- 模板内容：直接存储解析前的原始 JSON，以保证与 MVU/SAM 脚本兼容。
- 预留字段：
  - `templateSchemaVersion`：指明解析器版本，未来兼容结构变动。
  - `lastValidator`：记录最近一次通过的校验规则集。

## 5. 实施里程碑

1. **模型层实现**
   - 解析/序列化器原型，覆盖 `$meta`、说明元组、特殊标记。
   - 单元测试：针对 MVU 示例模板确保往返一致。
2. **校验与提示**
   - 基础校验：必填字段、类型匹配、扩展性约束。
   - 错误消息与 UI 联动。
3. **UI 迭代**
   - 初版：JSON 编辑器 + 基础树视图。
   - 增强：表单控件、说明预览、快捷编辑。
4. **后端同步与版本化**
   - 在保存流程中附加 `templateSchemaVersion`。
   - 服务器记录版本信息，为快照功能奠定基础。

## 6. 后续关注点

- 与记忆增强扩展的变量引用接口对齐，明确跨扩展数据同步规范。
- 设计批量操作与脚本 API（如 `_.assign` 可视化辅助）所需的用户体验。
- 预研快照/回滚 UI，与当前模板编辑界面保持一致的视觉规则。
