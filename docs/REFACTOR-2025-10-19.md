# 2025-10-19 重构记录

## 重构目标

回归到最小可用实现：模板就是初始化快照，前端只负责提供编辑界面和角色卡读写。

## 主要变更

### 1. 简化 templateState

**移除的字段：**

- `editorContainer` - 不需要单独追踪容器
- `currentModel` / `loadedModel` - 不需要解析模型
- `templateMeta` - 不需要额外元数据（templateId、updatedAt 等）
- `parserError` / `schemaVersion` - 不需要解析状态

**保留的字段：**

```javascript
const templateState = {
  editorController: null, // 编辑器控制器实例
  currentCharacterId: null, // 当前角色 ID
  templateBody: null, // 角色卡中保存的模板 JSON
  draftBody: null, // 编辑器中的副本
  enabled: false, // 是否启用变量系统
  dirty: false, // 是否有未保存修改
  hasErrors: false, // JSON 编辑器是否有错误
  loading: false, // 是否正在加载
};
```

### 2. 移除不必要的功能

**移除的按钮和功能：**

- Reset（重置为默认骨架）
- Reparse（重新解析）
- Schema 信息显示

**移除的函数：**

- `normalizeTemplate()` - 不再需要解析逻辑
- `applyTemplateResult()` - 不再需要应用解析结果
- `buildExtensionPayload()` - 直接构建简单 payload
- `generateTemplateId()` - 不再需要生成模板 ID
- `formatTimestamp()` - 不再显示时间戳
- `persistTemplateToPlugin()` - 暂不写入插件
- `refreshEditorRendering()` - 简化为直接设置编辑器值
- `setEditorContent()` / `getEditorContent()` - 直接使用控制器方法

**重命名的函数：**

- `cloneTemplate()` → `cloneJSON()` - 更准确的命名

### 3. 简化核心流程

#### 加载流程（refreshTemplateForActiveCharacter）

```javascript
// 旧逻辑：解析模板 → 应用结果 → 同步多个状态字段
const normalizationResult = normalizeTemplate(sourceTemplate);
applyTemplateResult(normalizationResult, { markAsLoaded: hasTemplate });
// ...复杂的元数据管理

// 新逻辑：直接读取和设置 JSON
templateState.templateBody = hasTemplate ? cloneJSON(loadedBody) : null;
templateState.draftBody = cloneJSON(loadedBody);
controller.setValue(templateState.draftBody ?? {}, { silent: true });
```

#### 保存流程（saveCurrentTemplate）

```javascript
// 旧逻辑：生成 templateId → 写插件 → 更新多个元数据字段
const payload = {
  templateId,
  templateBody: json,
  updatedAt: Date.now(),
  enabled: templateState.enabled,
};
await persistTemplateToPlugin(templateId, json);
// ...

// 新逻辑：只保存必要字段
const payload = {
  templateBody: json,
  enabled: templateState.enabled,
};
await writeExtensionField(characterId, TEMPLATE_EXTENSION_KEY, payload);
```

#### 清空流程（clearTemplateForActiveCharacter）

```javascript
// 旧逻辑：使用 buildExtensionPayload + 元数据管理
// 新逻辑：直接构建最小 payload
const payload = { enabled: templateState.enabled };
await writeExtensionField(characterId, TEMPLATE_EXTENSION_KEY, payload);
```

### 4. 角色卡数据结构

**写入角色卡的字段：**

```javascript
character.data.extensions.st_var_system = {
  enabled: boolean, // 是否启用变量系统
  templateBody: object, // 模板 JSON（可选）
};
```

**移除的字段：**

- `templateId` - 不需要唯一标识符
- `updatedAt` - 不需要时间戳
- `templateSchemaVersion` - 不需要版本号

### 5. 默认模板结构

```javascript
{
  metadata: {
    name: "角色名",
    createdAt: "2025-10-19T...",
  },
  variables: {}
}
```

移除了 `version` 字段，因为不需要版本管理。

## 代码行数变化

- 原：~967 行
- 现：~620 行
- 减少：~350 行（约 36%）

## 下一步计划

1. **模板功能验证**：在 SillyTavern 中测试基本的加载/保存/清空流程
2. **编辑器增强**：设计更友好的 JSON 查看和操作界面
3. **快照生成**：实现从 AI 回复中解析函数指令并生成快照的逻辑

## 设计原则

- **最小化**：只保留实现核心功能所需的最少代码
- **直接**：避免不必要的抽象层和中间状态
- **可扩展**：虽然简化了，但保持了未来扩展的可能性（通过 JSON 内容）
- **聚焦**：前端只负责编辑和读写，其他逻辑交给脚本层
