# 模板与编辑器功能实现计划

## 状态更新（2025-10-19）

**架构重新对齐**：根据用户明确的需求，已经移除了过度设计的部分，回归最小可用实现。

### 核心理念

1. **模板 = 初始化快照**：角色卡中的模板就是一份 JSON，用于新对话开始时生成第一条快照和标识符
2. **标识符 → 快照 → 变量块**：运行时通过标识符查询快照，结合值查询生成完整变量块，覆盖酒馆原生变量
3. **前端职责**：提供好用的编辑/展示界面 + 模板在角色卡中的读写
4. **脚本层处理**：标识符绑定、快照增量更新、函数调用解析等逻辑在脚本层完成

### 不需要的东西

- ❌ 固定 schema 结构
- ❌ 模板版本管理（schemaVersion）
- ❌ 解析模型和序列化器
- ❌ 全局模板库（至少现阶段不需要）
- ❌ diff 和回滚功能
- ❌ 复杂的元数据（templateId、updatedAt 等）

## 1. 当前目标

### 第一阶段：模板功能（进行中）

**目标**：让角色卡里的模板 JSON 能正常读写和编辑

**已完成**：

- ✅ 简化 templateState，只保留最小必要字段
- ✅ 移除解析器/序列化器依赖
- ✅ 简化加载/保存/清空流程
- ✅ 代码从 ~967 行减少到 ~620 行

**待完成**：

- [ ] 在 SillyTavern 中测试基本流程
- [ ] 修复任何运行时问题
- [ ] 确保与现有功能兼容

### 第二阶段：编辑器功能（下一步）

**目标**：设计一个方便操作 JSON 的界面，避免用户直接面对原始 JSON

**重点**：

- 这是真正需要创造力的地方
- 要支持模板、全局库、快照三种来源
- 查看和操作都要直观易用

**待设计**：

- [ ] 编辑器 UI 草案（树形视图？表单视图？）
- [ ] 变量快速添加/删除/修改
- [ ] 元数据显示（来源、类型等）
- [ ] 搜索和过滤功能

### 第三阶段：快照生成逻辑（未来）

**目标**：解析 AI 回复中的函数指令，修改上一个快照生成新快照

**核心流程**：

1. 监听 AI 回复生成事件
2. 从最后一层 AI 回复开始查找标识符
3. 有标识符 → 引用快照 + 应用函数调用
4. 无标识符 → 向上查找或使用角色卡模板
5. 生成新的标识符和快照

## 2. 当前实现状态

### 模板状态

```javascript
const templateState = {
  editorController: null, // 编辑器控制器实例
  currentCharacterId: null, // 当前角色 ID
  templateBody: null, // 角色卡中保存的模板 JSON
  draftBody: null, // 编辑器中的副本
  enabled: false, // 是否启用变量系统
  dirty: false, // 是否有未保存修改
  hasErrors: false, // JSON 编辑器是否有错误
  loading: false, // 是否正在加载
};
```

### 角色卡数据结构

```javascript
character.data.extensions.st_var_system = {
  enabled: boolean, // 是否启用变量系统
  templateBody: object, // 模板 JSON（可选）
};
```

### 默认模板结构

```javascript
{
  metadata: {
    name: "角色名",
    createdAt: "2025-10-19T...",
  },
  variables: {}
}
```

### 可用按钮

- **保存**：将 draftBody 写回角色卡
- **撤销**：从 templateBody 恢复 draftBody
- **重新加载**：强制重新从角色卡读取
- **清空**：删除角色卡中的模板（保留启用状态）
- **启用开关**：切换 enabled 字段

## 3. 设计原则

1. **最小化**：只保留实现核心功能所需的最少代码
2. **直接**：避免不必要的抽象层和中间状态
3. **可扩展**：通过 JSON 内容本身实现扩展，不需要框架级支持
4. **聚焦**：前端只负责编辑和读写，其他逻辑交给脚本层

## 4. 未来扩展方向（待讨论）

这些都不是现在要做的，只是记录可能的方向：

- 全局模板库（如果确实需要复用模板）
- 快照浏览器（查看历史快照）
- 可视化编辑器（图形化编辑变量）
- 模板验证（基于 JSON 内容的校验规则）

任何扩展都要：

1. 先与用户讨论必要性
2. 确认设计方案
3. 再开始实现

## 5. 参考文档

- `REFACTOR-2025-10-19.md` - 本次重构的详细记录
- `variable-block-editor.md` - 编辑器组件设计（待更新）
- `implementation-plan-variable-storage.md.old` - 旧的实现计划（已废弃）
