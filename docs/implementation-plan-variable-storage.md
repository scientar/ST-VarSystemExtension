# 模板与编辑器功能实现计划

## 1. 范围与目标

### 目标

1. 在变量系统前端扩展中支持与 MVU 模板等价的数据结构（含 `$meta`、`$__META_EXTENSIBLE__$` 标记），并确保后端插件能够持久化该结构而不丢失语义。
2. 建立“角色卡模板 + 全局模板库 + 快照”统一的编辑器体验，实现模板的编辑、保存、复用与覆盖流程。
3. 为后续解析函数与快照系统提供所需的元信息与启用状态数据。

### 范围

- 前端解析/序列化模块与状态管理改造（已开工）。
- 编辑器容器抽象，支持角色卡模板、全局模板、快照共用。
- 全局模板库的增删改查、唯一 ID 策略与角色卡间复用流程。
- 后端模板接口扩展（schemaVersion、全局模板 CRUD、元信息记录）。
- 单元测试/集成验证脚本。

### 不在本轮处理

- 快照浏览界面、复杂表单 UI、模型级校验器执行。

> 进度注记：原计划中的 M1（解析与模型层）已完成；M2 第一阶段正在整合中，目前仅模板加载流程接入了新的解析/编辑器控制器，保存与手动重新解析仍待补全。下述里程碑将基于此继续推进。

## 2. 里程碑

1. **M1：解析与模型层（已完成）**
   - `parser` / `serializer` 实现 `$meta`、`$__META_EXTENSIBLE__$`、说明元组往返一致。
   - 基础类型定义与往返单测。
2. **M2：角色卡模板接入（进行中）**
   - 角色卡模板加载/保存使用解析模型（已完成基础部分）。
   - 扩展启用开关与模板状态展示（待 UI 提示、错误处理完善）。
3. **M3：全局模板库实现**
   - 前端：提供“保存为全局模板”“从全局模板加载/覆盖”功能，支持唯一 ID 管理与元数据填写。
   - 后端：新增模板 CRUD API（列表、读取、创建、更新、删除），记录创建者、更新时间、引用统计等。
   - 数据库：模板表扩展 schemaVersion、templateBody、描述信息等字段。
4. **M4：统一编辑器容器**
   - 抽象编辑器组件，支持角色卡模板/全局模板/快照三种来源。
   - 提供模式切换（查看/编辑）、状态栏（schemaVersion、来源类型、保存状态）。
   - 集成大体量内容的虚拟滚动、搜索、高亮（按 3.3 设计）。
5. **M5：启用状态与快照联动**
   - 明确启用字段对快照生成、标识符计算的影响。
   - 在保存/加载流程中同步启用状态与默认快照骨架检查。
6. **M6：验证与文档**
   - 端到端脚本覆盖角色卡 ↔ 全局模板的保存/覆盖流程。
   - 更新说明文档，标注模板使用指南与 API 变更。

## 3. 任务拆解

### M1 解析与模型层（已完成）

- 创建 `parser.js` / `serializer.js`，实现往返逻辑。
- `types.d.ts` 完成类型声明。
- 单元测试 `tests/template-parser.test.mjs` 验证往返一致。

### M2 角色卡模板接入（进行中）

\- [进行中] `index.js` 使用解析器加载/保存模板：加载阶段已切换到 `normalizeTemplate`/`applyTemplateResult` 与 `VariableBlockEditor` 控制器，保存仍依赖旧的 `editor.get()` 接口且未写回解析模型。
\- [部分完成] UI 显示 schemaVersion、解析错误状态；支持手动重新解析：`updateSchemaInfo` 已接入新状态，但 `reparseCurrentDraft` 按钮缺少实现。
\- [未完成] 提供“重置为默认骨架”操作并清空角色卡字段时回退至骨架：`resetTemplateToDefault` 未落地，清空流程仍沿用旧逻辑。
\- [未完成] 保存时写入 `templateSchemaVersion` 字段，并与解析结果保持一致：当前保存流程仍未持久化 schemaVersion。
\- [部分完成] 当解析失败或 JSON 编辑器有错误时，阻止写入插件并给出明确状态提示文案：加载阶段状态提示已更新，保存阶段仍需校验编辑器错误并统一提示等级。

### M3 全局模板库（待开发）

#### 前端

- 新增“模板管理”抽屉页签，列出全局模板，支持搜索、筛选、预览。
- 在角色卡模板页面提供“保存为全局模板”“从全局模板加载并覆盖”按钮。
- 统一使用编辑器容器显示全局模板详情，支持编辑与另存。
- 保存时提示填写模板名称、标签、描述，生成唯一 ID（可用 `uuid:` 前缀）。

#### 后端

- 扩展 `/var-manager/templates` 为 REST 资源：`GET /templates`（列表）、`GET /templates/:id`、`POST`、`PUT`、`DELETE`。
- 数据库 schema：`id`（主键）、`name`、`description`、`template_body`、`schema_version`、`created_at`、`updated_at`、`usage_count`。
- 兼容旧接口（按角色名存储）或提供迁移脚本。

### M4 统一编辑器容器

- 抽象 `TemplateViewer`（暂为纯 JS + DOM），封装 JSON 编辑器实例管理、虚拟滚动、搜索、模式切换。
- 支持 `sourceType: "character" | "global" | "snapshot"`，根据来源显示不同操作按钮。
- 提供公共状态：`dirty`、`hasErrors`、`schemaVersion`、`parserError`。
- 预留钩子以便未来接入树形/表单视图。

### M5 启用状态与快照联动

- 保存角色卡模板时确保 `enabled` 与模板存在性一致（无模板时默认 false 并提示）。
- 在启用开关变更时检查模板是否存在，若缺失则提示用户导入。
- 明确快照生成条件：`enabled && template存在 && 模板已解析成功`。
- 准备 `buildDefaultSnapshotSkeleton`（参考模板）并在启用时校验。

### M6 验证与文档

- 创建脚本 `scripts/verify-template-flow.mjs`：

      1. 模拟角色卡加载默认模板。
      2. 保存为全局模板并从列表读取。
      3. 覆盖角色卡模板，再次读取确保一致。

- 更新 `docs/variable-system-data-plan.md` 记录全局模板库与统一编辑器行为。
- 更新 README 或新增用户指南，说明角色卡与全局模板使用步骤。

## 6. 近期行动列表

1. M2 剩余事项（进行中）：补齐保存流程的 schemaVersion 写回、重置/重新解析按钮逻辑、状态提示复核。
2. 统一变量块编辑器草稿（基础完成）：已有初版模块与文档，需继续拆分迁移 checklist。
3. 全局模板库任务拆分（进行中）：草案已成文，等待与后端设计对齐。
4. ST-VarSystemPlugin 接口/数据库草案（待启动）：前端需求已经列出，需安排插件端同步设计。
5. 端到端验证脚本大纲（待启动）：待保存/加载流程稳定后补充脚本步骤。

### 6.1 行动 1：M2 剩余事项执行计划

1. 代码定位：梳理 `index.js` 中模板保存流程（`buildExtensionPayload`、`saveCurrentTemplate`、`clearTemplateForActiveCharacter`），确认写入场景。（初次梳理完成，待结合新编辑器接口更新保存逻辑）
2. `templateSchemaVersion` 持久化：（未完成）
   - 需要在保存时将 `normalizeTemplate` 的 `schemaVersion` 写入扩展字段，清空流程同步重置。
   - 与插件交互时补充 schemaVersion 字段，确认兼容性或添加 TODO。
   - 补充 round-trip 验证，防止新字段丢失。
3. 错误提示复核：（部分完成）
   - 加载阶段的状态提示已对齐分级；保存/清空流程仍需统一文案与等级。
   - 插件缺失的降级提示需覆盖保存失败场景。
4. 验证与记录：运行现有 `npm test`，并在文档/变更日志中补充说明字段新增与提示调整，供后续步骤引用。（待保存流程更新后执行）

### 6.2 状态提示分级约定

- **error**：操作无法继续，必须由用户处理后再重试，例如未选择角色、模板解析失败、写入角色卡异常。
- **warn**：核心流程已完成但存在降级或需要关注的状态，例如 JSON 未保存、插件缺失/写入失败、编辑器降级为纯文本模式、默认骨架待保存。
- **info**：中间状态或普通提示，如加载进度、取消操作、无模板可清空等。
- **success**：仅在角色卡写入成功且已同步到服务器插件时展示，例如模板已保存并同步。

### 6.3 行动 2：统一变量块编辑器草稿计划

目标：提供一个可复用的编辑器容器，服务角色卡模板、全局模板、快照三类变量块，在后续阶段逐步扩展到更友好的视图。

步骤：

1. **现状梳理**：
   - 审查 `index.js` 中现有 editor 实例管理、状态同步（`ensureEditorInstance`、`handleEditorChange`、`refreshEditorRendering`）。
   - 记录与 UI 元素交互点：按钮、状态栏（schema、脏状态、启用开关）。
   - 汇总未来来源类型（角色卡、全局库、快照）需要的共性与差异。

2. **草稿输出**：
   - 定义 `VariableBlockEditor` 抽象（纯 JS 模块），包含：
     - `mount(container, options)`：创建并渲染编辑器；
     - `update(options)`：切换数据源、只读模式、状态信息；
     - `getValue()` / `setValue(value, { silent })`；
     - 事件钩子（`onChange`, `onParse`, `onError`）。
   - 统一状态条结构：显示来源标签、schemaVersion、dirty/错误提示、最近同步结果。
   - 兼容文本模式为主，预留“视图模式”切换钩子（未来接入树/表单）。

3. **依赖与集成**：
   - 确认继续使用 `vanilla-jsoneditor` 的 standalone 版本；记录降级策略。
   - 规划与现有按钮/操作的对接方式（例如角色卡页的“保存”“重置”，全局模板页的“应用到角色卡”）。

4. **交付物**：
   - [done] 文档草稿（本文件或独立 `docs/variable-block-editor.md`）描述组件接口和最小 UI 布局。
   - [done] 新建占位模块文件（如 `src/editor/variableBlockEditor.js`）并写出骨架代码，暂不改变现有逻辑，仅导出计划中的接口 TODO。
   - [todo] 补充后续任务条目，描述将角色卡模板编辑器迁移到新容器的步骤。
5. **迁移任务分解**（新增 todo）：
   1. 梳理现有 `bindTemplateSection`/`ensureEditorInstance` 与按钮事件，将可复用逻辑移入 `VariableBlockEditor`。
   2. 编写迁移 checklist，列出角色卡模板页面需重构的入口与状态同步点。
   3. 规划测试步骤（单元 + 手动）确保迁移后保存、重置、重新解析等功能保持一致。
   4. 明确在全局模板库页面/快照查看器中嵌入新组件的定制差异。

### 6.4 行动 3：全局模板库任务拆分与 API 草案

目标：明确前端全局模板库功能模块及其与后端插件接口的耦合点，形成可实施的任务清单与初步 API 规格。

步骤：

1. **需求盘点**：
   - 前端需要的视图：模板列表（筛选/搜索）、模板详情（编辑器 + 元信息）、角色卡覆盖确认弹窗。
   - 操作流程：从角色卡保存到全局库、从库加载覆盖角色卡、在库内修改模板、删除模板、复制模板。

2. **前端任务划分**：
   - `GlobalTemplateList` 抽屉页：数据拉取、分页/搜索 UI、选择模板后进入详情。
   - `GlobalTemplateDetail` 面板：复用 `VariableBlockEditor`，附带模板元信息表单（名称、描述、标签、schemaVersion）。
   - 跨页面操作按钮：
     1. 角色卡模板页新增“保存为全局模板”动作（调用创建接口）。
     2. 列表/详情页提供“覆盖当前角色卡模板”动作（调用读取接口后写入角色卡字段）。
     3. 详情页支持“另存为”“删除”“复制ID”按钮。
   - 状态管理：引入 `globalTemplateStore`（临时模块）缓存列表、当前选择、加载状态。

3. **后端 API 需求整理**（初稿）：
   - `GET /templates`：参数 `search`, `tag`, `page`, `pageSize`；返回模板概要列表。
   - `GET /templates/:id`：返回完整 `templateBody`, `schemaVersion`, `metadata`。
   - `POST /templates`：创建模板，字段包括 `name`, `description`, `tags`, `schemaVersion`, `templateBody`, `valuePoolSnapshot`。
   - `PUT /templates/:id`：更新模板内容与元信息。
   - `DELETE /templates/:id`：删除模板，返回操作结果。
   - 未来扩展：`POST /templates/:id/clone`、`GET /templates/:id/history`。

4. **依赖关系**：
   - 列表视图在初版可先加载全部模板（数量可控），若数据量较大改用分页。
   - 需要插件侧提供唯一 ID（若前端生成 UUID 需确保与后端约定一致）。
   - 模板元信息字段与 MVU 对齐（名称/描述/标签）以便迁移。

5. **交付物**：
   - [done] 文档：`docs/global-template-library.md` 描述前端模块结构与 API 规格。
   - 任务列表：拆分为 PR 粒度的 checklist，供后续实现跟踪。
   - 风险记录：包括大体量模板加载、并发编辑冲突、ID 命名策略。

完成标准：上层确认任务拆分与 API 草案后，进入实现阶段（前端与插件端可并行推进）。

里程碑完成标准：草稿文档获得确认后，再将其并入代码实现阶段。该阶段不涉及实际 UI 替换，仅落地设计与骨架文件。

## 4. 依赖与风险

- **依赖**：SillyTavern 扩展 API 稳定；现有 JSON 编辑器可继续使用文本模式。
- **风险**：
  - 元数据解析与 MVU 实际逻辑存在差异 → 通过阅读 MVU 源码与示例测试降低风险。
  - 大体量 JSON 性能问题 → 本轮仍主要使用文本模式编辑，后续 UI 优化时重点关注。
  - 后端 schema 迁移需谨慎，确保已有数据自动补齐 `schemaVersion`。

## 5. 交付标准

### 角色卡模板

- 与 MVU 示例往返一致，`templateSchemaVersion` 正确写入。
- 启用开关与模板存在性联动，解析失败时提示用户。

### 全局模板库

- 可将当前编辑内容另存为全局模板，自动生成 ID 与元信息。
- 可从库中选择模板加载到编辑器，并一键覆盖角色卡模板。
- 列表/API 支持查询、更新、删除，并记录 `schemaVersion`。

### 统一编辑器

- 角色卡/全局模板/快照均可在同一界面查看与编辑。
- 提供大体量内容的虚拟滚动与搜索，支持原始 JSON 与后续扩展视图切换。

### 验证

- 端到端脚本与文档更新完备，说明模板与编辑器的使用方式。

## 7. 当前进展纪要（2025-10-19）

- 已完成：抽离并落地 `src/editor/variableBlockEditor.js`，支持 JSON 编辑器资源加载失败时的纯文本降级；角色卡模板加载路径改用 `normalizeTemplate`/`applyTemplateResult` 并同步 Schema 指示。
- 部分完成：模板状态栏与启用开关已与新状态字段联动，但 `reparseCurrentDraft`、`resetTemplateToDefault` 等操作尚未实现，保存流程仍调用旧版 `editor.get()`。
- 待处理：`templateSchemaVersion` 在保存/清空流程中的持久化、插件写入失败的状态提示、编辑器控制器 `getValue` 对接、全局模板库交互。
- 备注：本周多次尝试合并阶段性成果时因 `git restore index.js` 回滚，现阶段代码仅保留已验证的加载路径和编辑器封装改动，后续迭代需在此基础上继续推进并避免遗漏按钮逻辑。
